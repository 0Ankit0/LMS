@page "/user/lms/dashboard"
@using LMS.Models.Course
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<div class="container-fluid py-4" style="background: #f6f7fb; min-height: 100vh;">
    <div class="row g-4 mb-4">
        <!-- Continue with Course -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100" style="background: #fff; border-radius: 18px;">
                <div class="card-body d-flex align-items-center" style="padding: 2rem;">
                    <img src="@ContinueCourse.ThumbnailUrl" class="rounded-4 shadow-sm me-4" style="width: 140px; height: 90px; object-fit: cover; background: #e9ecef;" alt="Course image" />
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-primary bg-opacity-10 text-primary fw-semibold me-2" style="font-size: 0.9rem;">Continue Course</span>
                        </div>
                        <h4 class="fw-bold mb-1" style="letter-spacing: -0.5px;">@ContinueCourse.Title</h4>
                        <p class="mb-3 text-muted" style="font-size: 1rem;">@ContinueCourse.Description</p>
                        <a class="btn btn-primary px-4 py-2 rounded-pill fw-semibold" href="@($"/courses/details?id={ContinueCourse.Id}")" style="font-size: 1rem;">
                            Go to Course <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <!-- Your Progress -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100" style="background: #fff; border-radius: 18px;">
                <div class="card-title fs-4 text-center fw-bold text-primary mt-2" style="font-size: 1.1rem; width: 100%;">Your Progress</div>
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                      <select class="form-select form-select-sm w-full" @onchange="OnProgressCourseChanged" style="border-radius: 12px;">
                            @foreach (var item in ProgressCourses)
                            {
                                <option value="@item.Course.Id" selected="@(item.Course.Id == SelectedProgressCourse.Id)">
                                    @item.Course.Title
                                </option>
                            }
                        </select>
                    <div class="w-100 m-2 d-flex">
                        <div class="position-relative mx-auto" style="width: 110px; height: 110px;">
                            <svg width="110" height="110">
                                <circle cx="55" cy="55" r="48" stroke="#e9ecef" stroke-width="10" fill="none" />
                                <circle cx="55" cy="55" r="48" stroke="#4e73df" stroke-width="10" fill="none"
                                        stroke-dasharray="301.592"
                                        stroke-dashoffset="@((1 - SelectedProgressCourseProgress / 100.0) * 301.592)"
                                        stroke-linecap="round"
                                        style="transition: stroke-dashoffset 0.5s;" />
                            </svg>
                            <div class="position-absolute top-50 start-50 translate-middle text-center">
                                <span class="fw-bold" style="font-size: 2rem;">@SelectedProgressCourseProgress.ToString("F0")%</span>
                            </div>
                        </div>
                        <div class="justify-content-center">

                        <div class="text-bold text-center mb-2" style="font-size: 1rem; width: 100%;">@SelectedProgressCourse.Title</div>
                        <div class="text-muted text-center small mb-2" style="min-height: 38px; width: 100%;">@SelectedProgressCourse.Description</div>
                        </div>
                    </div>
                        <div class="d-flex justify-content-center">
                            <a class="btn btn-outline-primary btn-sm rounded-pill fw-semibold" href="@($"/courses/details?id={SelectedProgressCourse.Id}")">
                                Go to Course <i class="bi bi-arrow-right ms-1"></i>
                            </a>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- New Courses -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100" style="background: #fff; border-radius: 18px;">
                <div class="card-body" style="padding: 2rem;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold text-primary" style="font-size: 1.1rem;">New Courses</span>
                        <a class="btn btn-link btn-sm px-0 fw-semibold" href="/courses" style="text-decoration: none;">See All</a>
                    </div>
                    <div class="row g-3">
                        @foreach (var course in NewCourses)
                        {
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="border-radius: 14px;">
                                    <img src="@course.ThumbnailUrl" class="card-img-top rounded-top" style="height: 90px; object-fit: cover; background: #e9ecef;" alt="Course image" />
                                    <div class="card-body p-2">
                                        <h6 class="fw-bold mb-1" style="font-size: 1rem;">@course.Title</h6>
                                        <p class="text-muted small mb-2">@course.Description</p>
                                        <a class="btn btn-outline-primary btn-sm w-100 rounded-pill fw-semibold" href="@($"/courses/details?id={course.Id}")">View</a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
        <!-- Your Courses -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100" style="background: #fff; border-radius: 18px;">
                <div class="card-body" style="padding: 2rem;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold text-primary" style="font-size: 1.1rem;">Your Courses</span>
                        <a class="btn btn-link btn-sm px-0 fw-semibold" href="/user/courses" style="text-decoration: none;">See All</a>
                    </div>
                    <div class="row g-3">
                        @foreach (var course in YourCourses)
                        {
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm h-100" style="border-radius: 14px;">
                                    <img src="@course.ThumbnailUrl" class="card-img-top rounded-top" style="height: 90px; object-fit: cover; background: #e9ecef;" alt="Course image" />
                                    <div class="card-body p-2">
                                        <h6 class="fw-bold mb-1" style="font-size: 1rem;">@course.Title</h6>
                                        <p class="text-muted small mb-2">@course.Description</p>
                                        <a class="btn btn-outline-primary btn-sm w-100 rounded-pill fw-semibold" href="@($"/courses/details?id={course.Id}")">View</a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- Upcoming Courses -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100" style="background: #fff; border-radius: 18px;">
                <div class="card-body" style="padding: 2rem;">
                    <div class="fw-bold text-primary mb-3" style="font-size: 1.1rem;">
                        Upcoming Courses
                    </div>
                    @if (UpcomingCourses.Any())
                    {
                        @foreach (var course in UpcomingCourses)
                        {
                            <div class="d-flex align-items-center mb-3 p-3" style="background: #f6f7fb; border-radius: 12px;">
                                <img src="@course.ThumbnailUrl" class="rounded-3 shadow-sm me-3" style="width: 70px; height: 50px; object-fit: cover; background: #e9ecef;" alt="Course image" />
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-1" style="font-size: 1rem;">@course.Title</h6>
                                    <p class="text-muted small mb-1">@course.Description</p>
                                    <a class="btn btn-primary btn-sm px-3 rounded-pill fw-semibold" href="@($"/courses/details?id={course.Id}")">Go to Course</a>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted">No upcoming courses.</p>
                    }
                </div>
            </div>
        </div>
        <!-- Your Notes -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100" style="background: #fff; border-radius: 18px;">
                <div class="card-body" style="padding: 2rem;">
                    <div class="fw-bold text-primary mb-3" style="font-size: 1.1rem;">
                        Your Notes
                    </div>
                    @if (UserNotes.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var note in UserNotes)
                            {
                                <li class="list-group-item border-0 px-0 py-2" style="background: transparent;">
                                    <div class="fw-bold mb-1" style="font-size: 1rem;">@note.Title</div>
                                    <div class="text-muted small">@note.Content</div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted">No notes yet.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Mock data for demonstration. Replace with real data/service calls.
    private CourseModel ContinueCourse = new()
    {
        Id = 1,
        Title = "Blazor Fundamentals",
        Description = "Learn the basics of Blazor and build interactive web UIs.",
        ThumbnailUrl = "/course.png"
    };

    private List<CourseModel> NewCourses = new()
    {
        new CourseModel { Id = 2, Title = "Advanced C#", Description = "Deep dive into C# features.", ThumbnailUrl = "/course.png" },
        new CourseModel { Id = 3, Title = "Entity Framework Core", Description = "Master data access with EF Core.", ThumbnailUrl = "/course.png" }
    };

    private List<CourseModel> YourCourses = new()
    {
        new CourseModel { Id = 1, Title = "Blazor Fundamentals", Description = "Learn the basics of Blazor and build interactive web UIs.", ThumbnailUrl = "/course.png" },
        new CourseModel { Id = 4, Title = "ASP.NET Core Web API", Description = "Build RESTful APIs with ASP.NET Core.", ThumbnailUrl = "/course.png" }
    };

    private List<CourseModel> UpcomingCourses = new()
    {
        new CourseModel { Id = 5, Title = "Microservices Architecture", Description = "Design scalable microservices.", ThumbnailUrl = "/course.png" }
    };

    // For progress, you may want to store progress percentage in a separate model or extend CourseModel.
    private List<(CourseModel Course, double Progress)> ProgressCourses = new()
    {
        (new CourseModel { Id = 1, Title = "Blazor Fundamentals", Description = "Learn the basics of Blazor and build interactive web UIs.", ThumbnailUrl = "/course.png" }, 70),
        (new CourseModel { Id = 4, Title = "ASP.NET Core Web API",Description = "Build RESTful APIs with ASP.NET Core.", ThumbnailUrl = "/course.png" }, 40)
    };

    private int selectedProgressCourseId = 1;
    private CourseModel SelectedProgressCourse => ProgressCourses.FirstOrDefault(c => c.Course.Id == selectedProgressCourseId).Course ?? ProgressCourses.First().Course;
    private double SelectedProgressCourseProgress => ProgressCourses.FirstOrDefault(c => c.Course.Id == selectedProgressCourseId).Progress;

    private void OnProgressCourseChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var id))
        {
            selectedProgressCourseId = id;
        }
    }

    private List<UserNoteModel> UserNotes = new()
    {
        new UserNoteModel { Title = "Blazor Tips", Content = "Remember to use @key when rendering lists." },
        new UserNoteModel { Title = "API Auth", Content = "Use JWT for securing your APIs." }
    };

    public class UserNoteModel
    {
        public string Title { get; set; } = string.Empty;
        public string Content { get; set; } = string.Empty;
    }
}