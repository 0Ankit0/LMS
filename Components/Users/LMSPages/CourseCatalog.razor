@page "/user/lms/courses/catalog"
@using global::LMS.Models.Course
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@rendermode @(new InteractiveServerRenderMode())

<div class="course-catalog-layout">
    <!-- Categories Sidebar -->
    <div class="catalog-sidebar">
        <div class="sidebar-header">
            <h5 class="sidebar-title">Categories</h5>
        </div>
        <div class="sidebar-content">
            <div class="category-list">
                <div class="category-item @(selectedCategory == "all" ? "active" : "")"
                    @onclick='() => SelectCategory("all")'>
                    <div class="category-icon">
                        <i class="bi bi-bookmark-fill"></i>
                    </div>
                    <span class="category-text">All Courses</span>
                </div>
                <div class="category-item @(selectedCategory == "development" ? "active" : "")"
                    @onclick='() => SelectCategory("development")'>
                    <div class="category-icon">
                        <i class="bi bi-laptop"></i>
                    </div>
                    <span class="category-text">Development</span>
                </div>
                <div class="category-item @(selectedCategory == "business" ? "active" : "")"
                    @onclick='() => SelectCategory("business")'>
                    <div class="category-icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <span class="category-text">Business</span>
                </div>
                <div class="category-item @(selectedCategory == "design" ? "active" : "")"
                    @onclick='() => SelectCategory("design")'>
                    <div class="category-icon">
                        <i class="bi bi-paint-bucket"></i>
                    </div>
                    <span class="category-text">Design</span>
                </div>
                <div class="category-item @(selectedCategory == "security" ? "active" : "")"
                    @onclick='() => SelectCategory("security")'>
                    <div class="category-icon">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <span class="category-text">Security</span>
                </div>
            </div>

            <div class="filters-section">
                <h6 class="filter-title">Filters</h6>
                <div class="filter-group">
                    <span class="filter-label">Level</span>
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="checkbox" @bind="filters.Beginner" @bind:after="ApplyFilters">
                            <span>Beginner</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" @bind="filters.Intermediate" @bind:after="ApplyFilters">
                            <span>Intermediate</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" @bind="filters.Advanced" @bind:after="ApplyFilters">
                            <span>Advanced</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="catalog-main">
        <!-- Header -->
        <div class="catalog-header">
            <div class="header-info">
                <h3 class="page-title">Course Catalog</h3>
                <p class="page-subtitle">Discover and learn new skills</p>
            </div>
            <div class="header-actions">
                <div class="search-container">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search courses, instructors, topics..."
                        @bind="searchQuery" @oninput="OnSearchInput">
                </div>
                <div class="sort-dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-funnel me-1"></i> @GetSortDisplayText()
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item @(sortBy == "popular" ? "active" : "")" href="#"
                                @onclick='() => SetSort("popular")'>Most Popular</a></li>
                        <li><a class="dropdown-item @(sortBy == "newest" ? "active" : "")" href="#"
                                @onclick='() => SetSort("newest")'>Newest</a></li>
                        <li><a class="dropdown-item @(sortBy == "alphabetical" ? "active" : "")" href="#"
                                @onclick='() => SetSort("alphabetical")'>A-Z</a></li>
                        <li><a class="dropdown-item @(sortBy == "level" ? "active" : "")" href="#"
                                @onclick='() => SetSort("level")'>By Level</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Course Grid -->
        <div class="courses-content">
            <div class="course-grid">
                @if (filteredCourses.Any())
                {
                    @foreach (var course in filteredCourses)
                    {
                        <div class="course-card">
                            <div class="course-image-container">
                                <img src="@course.ThumbnailUrl" class="course-image" alt="Course image" />
                                <button class="bookmark-btn" @onclick="() => ToggleBookmark(course.Id)">
                                    <i
                                        class="bi @(bookmarkedCourses.Contains(course.Id) ? "bi-bookmark-fill" : "bi-bookmark")"></i>
                                </button>
                            </div>
                            <div class="course-info">
                                <div class="course-meta">
                                    <span class="course-level">@course.Level</span>
                                    <span class="course-duration">@FormatDuration(course.EstimatedDuration)</span>
                                </div>
                                <h6 class="course-title">@course.Title</h6>
                                <p class="course-description">@course.Description</p>
                                <div class="course-footer">
                                    <div class="instructor-info">
                                        <img src="/favicon.png" class="instructor-avatar" alt="Instructor">
                                        <span class="instructor-name">@course.InstructorName</span>
                                    </div>
                                    <a class="btn btn-primary btn-sm view-btn"
                                        href="@($"/user/lms/course/{course.Id}")">View</a>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="no-courses-found">
                        <i class="bi bi-search"></i>
                        <h5>No courses found</h5>
                        <p>Try adjusting your search criteria or filters.</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    // State variables
    private string selectedCategory = "all";
    private string searchQuery = "";
    private string sortBy = "popular";
    private FilterModel filters = new();
    private HashSet<int> bookmarkedCourses = new();
    private List<CourseModel> filteredCourses = new();

    // Mock data for demonstration. Replace with real data/service calls.
    private List<CourseModel> AllCourses = new()
{
new CourseModel
{
Id = 1,
Title = "Blazor Fundamentals",
Description = "Learn the basics of Blazor and build interactive web UIs.",
ThumbnailUrl = "/course.png",
Level = "Beginner",
EstimatedDuration = TimeSpan.FromMinutes(270),
InstructorName = "John Smith",
AverageRating = 4.5,
EnrollmentCount = 1250,
Categories = new List<string> { "development" },
StartDate = DateTime.Now.AddDays(-30)
},
new CourseModel
{
Id = 2,
Title = "Advanced C#",
Description = "Deep dive into C# features and advanced programming concepts.",
ThumbnailUrl = "/course.png",
Level = "Advanced",
EstimatedDuration = TimeSpan.FromMinutes(320),
InstructorName = "Sarah Johnson",
AverageRating = 4.8,
EnrollmentCount = 890,
Categories = new List<string> { "development" },
StartDate = DateTime.Now.AddDays(-20)
},
new CourseModel
{
Id = 3,
Title = "Entity Framework Core",
Description = "Master data access with EF Core and database design patterns.",
ThumbnailUrl = "/course.png",
Level = "Intermediate",
EstimatedDuration = TimeSpan.FromMinutes(210),
InstructorName = "Mike Davis",
AverageRating = 4.6,
EnrollmentCount = 750,
Categories = new List<string> { "development" },
StartDate = DateTime.Now.AddDays(-45)
},
new CourseModel
{
Id = 4,
Title = "ASP.NET Core Web API",
Description = "Build RESTful APIs with ASP.NET Core and modern practices.",
ThumbnailUrl = "/course.png",
Level = "Intermediate",
EstimatedDuration = TimeSpan.FromMinutes(180),
InstructorName = "Emily Brown",
AverageRating = 4.7,
EnrollmentCount = 950,
Categories = new List<string> { "development" },
StartDate = DateTime.Now.AddDays(-15)
},
new CourseModel
{
Id = 5,
Title = "Microservices Architecture",
Description = "Design scalable microservices with modern architecture patterns.",
ThumbnailUrl = "/course.png",
Level = "Advanced",
EstimatedDuration = TimeSpan.FromMinutes(240),
InstructorName = "David Wilson",
AverageRating = 4.9,
EnrollmentCount = 620,
Categories = new List<string> { "development" },
StartDate = DateTime.Now.AddDays(-10)
},
new CourseModel
{
Id = 6,
Title = "Business Analysis Fundamentals",
Description = "Learn core business analysis skills and methodologies.",
ThumbnailUrl = "/course.png",
Level = "Beginner",
EstimatedDuration = TimeSpan.FromMinutes(200),
InstructorName = "Lisa Anderson",
AverageRating = 4.3,
EnrollmentCount = 540,
Categories = new List<string> { "business" },
StartDate = DateTime.Now.AddDays(-35)
},
new CourseModel
{
Id = 7,
Title = "Project Management",
Description = "Master project management techniques and tools.",
ThumbnailUrl = "/course.png",
Level = "Intermediate",
EstimatedDuration = TimeSpan.FromMinutes(300),
InstructorName = "Robert Taylor",
AverageRating = 4.4,
EnrollmentCount = 680,
Categories = new List<string> { "business" },
StartDate = DateTime.Now.AddDays(-25)
},
new CourseModel
{
Id = 8,
Title = "UI/UX Design Principles",
Description = "Learn modern UI/UX design principles and best practices.",
ThumbnailUrl = "/course.png",
Level = "Beginner",
EstimatedDuration = TimeSpan.FromMinutes(180),
InstructorName = "Jennifer White",
AverageRating = 4.6,
EnrollmentCount = 420,
Categories = new List<string> { "design" },
StartDate = DateTime.Now.AddDays(-40)
},
new CourseModel
{
Id = 9,
Title = "Cybersecurity Basics",
Description = "Essential cybersecurity concepts and threat prevention.",
ThumbnailUrl = "/course.png",
Level = "Beginner",
EstimatedDuration = TimeSpan.FromMinutes(220),
InstructorName = "Mark Johnson",
AverageRating = 4.5,
EnrollmentCount = 380,
Categories = new List<string> { "security" },
StartDate = DateTime.Now.AddDays(-50)
},
new CourseModel
{
Id = 10,
Title = "Advanced Security Architecture",
Description = "Design secure systems and implement advanced security measures.",
ThumbnailUrl = "/course.png",
Level = "Advanced",
EstimatedDuration = TimeSpan.FromMinutes(280),
InstructorName = "Susan Miller",
AverageRating = 4.8,
EnrollmentCount = 290,
Categories = new List<string> { "security" },
StartDate = DateTime.Now.AddDays(-12)
}
};

    protected override void OnInitialized()
    {
        filteredCourses = AllCourses;
        ApplyFilters();
    }

    private void SelectCategory(string category)
    {
        selectedCategory = category;
        ApplyFilters();
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchQuery = e.Value?.ToString() ?? "";
        ApplyFilters();
    }

    private void SetSort(string sortType)
    {
        sortBy = sortType;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var courses = AllCourses.AsQueryable();

        // Apply category filter
        if (selectedCategory != "all")
        {
            courses = courses.Where(c => c.Categories.Contains(selectedCategory));
        }

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            courses = courses.Where(c =>
            c.Title.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
            c.Description.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
            c.InstructorName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase));
        }

        // Apply level filters
        if (filters.HasAnyLevelFilter())
        {
            courses = courses.Where(c =>
            (filters.Beginner && c.Level == "Beginner") ||
            (filters.Intermediate && c.Level == "Intermediate") ||
            (filters.Advanced && c.Level == "Advanced"));
        }

        // Apply sorting
        courses = sortBy switch
        {
            "popular" => courses.OrderByDescending(c => c.EnrollmentCount),
            "newest" => courses.OrderByDescending(c => c.StartDate),
            "alphabetical" => courses.OrderBy(c => c.Title),
            "level" => courses.OrderBy(c => c.Level == "Beginner" ? 1 : c.Level == "Intermediate" ? 2 : 3),
            _ => courses.OrderByDescending(c => c.EnrollmentCount)
        };

        filteredCourses = courses.ToList();
        StateHasChanged();
    }

    private void ToggleBookmark(int courseId)
    {
        if (bookmarkedCourses.Contains(courseId))
        {
            bookmarkedCourses.Remove(courseId);
        }
        else
        {
            bookmarkedCourses.Add(courseId);
        }
    }

    private string FormatDuration(TimeSpan duration)
    {
        var hours = (int)duration.TotalHours;
        var minutes = duration.Minutes;

        if (hours > 0)
        {
            return minutes > 0 ? $"{hours}h {minutes}m" : $"{hours}h";
        }
        return $"{minutes}m";
    }

    private string GetSortDisplayText()
    {
        return sortBy switch
        {
            "popular" => "Most Popular",
            "newest" => "Newest",
            "alphabetical" => "A-Z",
            "level" => "By Level",
            _ => "Sort by"
        };
    }

    // Helper classes
    public class FilterModel
    {
        public bool Beginner { get; set; }
        public bool Intermediate { get; set; }
        public bool Advanced { get; set; }

        public bool HasAnyLevelFilter() => Beginner || Intermediate || Advanced;
    }
}
