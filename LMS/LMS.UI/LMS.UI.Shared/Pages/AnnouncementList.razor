@using MudBlazor;
@using MudBlazor.Utilities;
@page "/user/lms/announcement-list"

@inject HttpClient HttpClient
@inject ISnackbar Snackbar

<PageTitle>Announcements - LMS</PageTitle>

<div class="announcements-layout">
    <!-- Announcements Sidebar as Tabs -->
    <div class="announcements-sidebar">
        <MudTabs @bind-ActivePanelIndex="@selectedFilterIndex" Elevation="2" Rounded="true" Class="mt-4" Orientation="Orientation.Vertical">
            <MudTabPanel Text="All Announcements">
                <MudButton Variant="Variant.Text" Color="Color.Primary" Class="@GetFilterClass("all")"
                           OnClick='@(() => SelectFilter(0))'>
                    <MudIcon Icon="@Icons.Material.Filled.Campaign" Class="me-2" />
                    All Announcements
                </MudButton>
            </MudTabPanel>
            <MudTabPanel Text="High Priority">
                <MudButton Variant="Variant.Text" Color="Color.Primary" Class="@GetFilterClass("high")"
                           OnClick='@(() => SelectFilter(1))'>
                    <MudIcon Icon="@Icons.Material.Filled.Warning" Class="me-2" />
                    High Priority
                </MudButton>
            </MudTabPanel>
            <MudTabPanel Text="Medium Priority">
                <MudButton Variant="Variant.Text" Color="Color.Primary" Class="@GetFilterClass("medium")"
                           OnClick='@(() => SelectFilter(2))'>
                    <MudIcon Icon="@Icons.Material.Filled.Info" Class="me-2" />
                    Medium Priority
                </MudButton>
            </MudTabPanel>
            <MudTabPanel Text="Low Priority">
                <MudButton Variant="Variant.Text" Color="Color.Primary" Class="@GetFilterClass("low")"
                           OnClick='@(() => SelectFilter(3))'>
                    <MudIcon Icon="@Icons.Material.Filled.Notifications" Class="me-2" />
                    Low Priority
                </MudButton>
            </MudTabPanel>
            <MudTabPanel Text="Recent">
                <MudButton Variant="Variant.Text" Color="Color.Primary" Class="@GetFilterClass("recent")"
                           OnClick='@(() => SelectFilter(4))'>
                    <MudIcon Icon="@Icons.Material.Filled.History" Class="me-2" />
                    Recent
                </MudButton>
            </MudTabPanel>
            <MudTabPanel Text="Date Range">
                <div class="filters-section ms-3">
                    <MudText Typo="Typo.subtitle1" Class="filter-title">Date Range</MudText>
                    <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined">
                        <MudButton OnClick='@(() => SelectDateFilter(0))' Variant="@(selectedDateFilterIndex == 0 ? Variant.Filled : Variant.Outlined)">
                            Today
                        </MudButton>
                        <MudButton OnClick='@(() => SelectDateFilter(1))' Variant="@(selectedDateFilterIndex == 1 ? Variant.Filled : Variant.Outlined)">
                            This Week
                        </MudButton>
                        <MudButton OnClick='@(() => SelectDateFilter(2))' Variant="@(selectedDateFilterIndex == 2 ? Variant.Filled : Variant.Outlined)">
                            This Month
                        </MudButton>
                        <MudButton OnClick='@(() => SelectDateFilter(3))' Variant="@(selectedDateFilterIndex == 3 ? Variant.Filled : Variant.Outlined)">
                            All Time
                        </MudButton>
                    </MudButtonGroup>
                </div>
            </MudTabPanel>
        </MudTabs>
    </div>

    <!-- Main Announcements Area -->
    <div class="announcements-main">
        <!-- Header -->
        <div class="announcements-header">
            <div class="header-info">
                <h3 class="page-title">Announcements</h3>
                <p class="page-subtitle">Stay updated with the latest news and information</p>
            </div>
            <div class="header-actions">
                <div class="search-container">
                    <MudTextField @bind-Value="searchQuery" Placeholder="Search announcements..." Variant="Variant.Outlined" Clearable="true" />
                </div>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RefreshAnnouncements">
                    <MudIcon Icon="@Icons.Material.Filled.Refresh" Class="me-2" />
                    Refresh
                </MudButton>
            </div>
        </div>

        <!-- Announcements Content -->
        <div class="announcements-content">
            @if (isLoading)
            {
                <div class="loading-container">
                    <div class="spinner">
                        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                    </div>
                    <p class="loading-text">Loading announcements...</p>
                </div>
            }
            else if (filteredAnnouncements?.Any() == true)
            {
                <div class="announcements-list">
                    @foreach (var announcement in filteredAnnouncements)
                    {
                        <MudCard Class="@GetFullAnnouncementCardClass(announcement.Priority)">
                            <MudCardContent Class="announcement-content">
                                <div class="d-flex align-items-center mb-2">
                                    <MudIcon Icon="@GetPriorityIconEnum(announcement.Priority)" Class="me-2 fs-4" Color="@GetPriorityBadgeColor(announcement.Priority)" />
                                    <MudText Typo="Typo.h5" Class="announcement-title fw-bold">@announcement.Title</MudText>
                                </div>
                                <div class="announcement-header d-flex flex-wrap align-items-center mb-2 gap-3">
                                    <span class="announcement-author d-flex align-items-center text-secondary">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" Class="me-1" />
                                        @announcement.AuthorName
                                    </span>
                                    <span class="announcement-date d-flex align-items-center text-secondary">
                                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Class="me-1" />
                                        @FormatDate(announcement.PublishedAt)
                                    </span>
                                    <MudChip T="string" Color="@GetPriorityBadgeColor(announcement.Priority)" Class="px-2">
                                        @announcement.Priority
                                    </MudChip>
                                </div>
                                <div class="d-flex align-items-center justify-content-between">
                                    <MudText Typo="Typo.body2" Class="announcement-excerpt text-muted">@GetExcerpt(announcement.Content)</MudText>
                                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                               OnClick="() => ShowAnnouncement(announcement)">
                                        <MudIcon Icon="@Icons.Material.Filled.Visibility" Class="me-2" />
                                        View
                                    </MudButton>
                                </div>
                            </MudCardContent>
                        </MudCard>
                    }
                </div>
            }
            else
            {
                <MudCard Elevation="2" Class="empty-state text-center py-5">
                    <MudCardContent>
                        <MudIcon Icon="@Icons.Material.Filled.Campaign" Size="Size.Large" Class="text-muted mb-3" />
                        <MudText Typo="Typo.h5">No announcements found</MudText>
                        <MudText Typo="Typo.body1">There are no announcements matching your current filters.</MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ClearFilters">Clear Filters</MudButton>
                    </MudCardContent>
                </MudCard>
            }
        </div>
    </div>
</div>

<MudDialog @bind-IsVisible="@isModalVisible" Options="@dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Announcement Details</MudText>
    </TitleContent>
    <DialogContent>
        @if (selectedAnnouncement is not null)
        {
            <div class="announcement-detail-meta mb-3">
                <div class="meta-item">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Primary" />
                    <span>@selectedAnnouncement.AuthorName</span>
                </div>
                <div class="meta-item">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Color="Color.Primary" />
                    <span>@selectedAnnouncement.PublishedAt.ToString("MMM dd, yyyy HH:mm")</span>
                </div>
                <div class="meta-item">
                    <MudChip T="string" Color="@GetPriorityBadgeColor(selectedAnnouncement.Priority)">
                        <MudIcon Icon="@GetPriorityIconEnum(selectedAnnouncement.Priority)" Class="me-1" />
                        @selectedAnnouncement.Priority Priority
                    </MudChip>
                </div>
            </div>
            <div class="announcement-detail-content">
                @((MarkupString)(selectedAnnouncement.Content ?? ""))
            </div>
        }
        else
        {
            <div>No announcement selected.</div>
        }
    </DialogContent>
</MudDialog>

<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OnShowModalClick">Launch static backdrop modal</MudButton>

@code {
    private int selectedFilterIndex = 0;
    private int selectedDateFilterIndex = 3; // Default to All Time
    private string searchQuery = "";
    private bool isLoading = true;

    // Collections and selected items
    private List<AnnouncementModel> announcements = new();
    private List<AnnouncementModel> filteredAnnouncements = new();
    private AnnouncementModel? selectedAnnouncement;

    // Modal reference
    private MudDialog? announcementDetailModal;
    private bool isModalVisible = false;
    private DialogOptions dialogOptions = new() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

    protected override async Task OnInitializedAsync()
    {
        await LoadAnnouncements();
    }

    private async Task LoadAnnouncements()
    {
        isLoading = true;

        try
        {
            // Load announcements from service
            announcements = await HttpClient.GetFromJsonAsync<List<AnnouncementModel>>("/api/announcements");
            ApplyFilters();
        }
        catch (Exception ex)
        {
            // Log error and use mock data
            Snackbar.Add($"Error loading announcements: {ex.Message}", Severity.Error);
            ApplyFilters();
        }
        finally
        {
            isLoading = false;
        }
    }
    private void SelectFilter(int index)
    {
        selectedFilterIndex = index;
        ApplyFilters();
    }

    private void SelectDateFilter(int index)
    {
        selectedDateFilterIndex = index;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredAnnouncements = announcements.Where(a => a.IsActive).ToList();

        // Apply priority filter
        string filterString = selectedFilterIndex switch
        {
            0 => "all",
            1 => "high",
            2 => "medium",
            3 => "low",
            4 => "recent",
            _ => "all"
        };

        if (filterString != "all")
        {
            if (filterString == "recent")
            {
                filteredAnnouncements = filteredAnnouncements
                .Where(a => a.PublishedAt >= DateTime.Now.AddDays(-7))
                .ToList();
            }
            else
            {
                filteredAnnouncements = filteredAnnouncements
                .Where(a => a.Priority.Equals(filterString, StringComparison.OrdinalIgnoreCase))
                .ToList();
            }
        }

        // Apply date filter
        if (selectedDateFilterIndex != 3) // 3 is All Time
        {
            var cutoffDate = selectedDateFilterIndex switch
            {
                0 => DateTime.Today,
                1 => DateTime.Now.AddDays(-7),
                2 => DateTime.Now.AddDays(-30),
                _ => DateTime.MinValue
            };

            if (cutoffDate != DateTime.MinValue)
            {
                filteredAnnouncements = filteredAnnouncements
                .Where(a => a.PublishedAt >= cutoffDate)
                .ToList();
            }
        }

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            filteredAnnouncements = filteredAnnouncements
            .Where(a => a.Title.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
            a.Content.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
            a.AuthorName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
            .ToList();
        }

        // Sort by date (newest first)
        filteredAnnouncements = filteredAnnouncements
        .OrderByDescending(a => a.PublishedAt)
        .ToList();

        StateHasChanged();
    }

    private async void ShowAnnouncement(AnnouncementModel announcement)
    {
        selectedAnnouncement = announcement;
        isModalVisible = true;
    }

    private void CloseModal()
    {
        isModalVisible = false;
        selectedAnnouncement = null;
    }

    private async Task RefreshAnnouncements()
    {
        await LoadAnnouncements();
    }

    private void ClearFilters()
    {
        selectedFilterIndex = 0;
        selectedDateFilterIndex = 3;
        searchQuery = "";
        ApplyFilters();
    }

    private string GetFilterClass(string filterName)
    {
        return filterName switch
        {
            "all" => selectedFilterIndex == 0 ? "mud-button-filled" : "mud-button-outlined",
            "high" => selectedFilterIndex == 1 ? "mud-button-filled" : "mud-button-outlined",
            "medium" => selectedFilterIndex == 2 ? "mud-button-filled" : "mud-button-outlined",
            "low" => selectedFilterIndex == 3 ? "mud-button-filled" : "mud-button-outlined",
            "recent" => selectedFilterIndex == 4 ? "mud-button-filled" : "mud-button-outlined",
            _ => "mud-button-outlined"
        };
    }

    // Returns the correct MudBlazor.Icons.Material.Filled icon for the given priority
    private string GetPriorityIconEnum(string? priority)
    {
        return (priority ?? "").ToLower() switch
        {
            "high" => Icons.Material.Filled.Warning,
            "medium" => Icons.Material.Filled.Info,
            "low" => Icons.Material.Filled.Notifications,
            _ => Icons.Material.Filled.Info
        };
    }

    // Returns the correct MudBlazor.Color enum for the given priority
    private MudBlazor.Color GetPriorityBadgeColor(string? priority)
    {
        return (priority ?? "").ToLower() switch
        {
            "high" => MudBlazor.Color.Error,
            "medium" => MudBlazor.Color.Warning,
            "low" => MudBlazor.Color.Info,
            _ => MudBlazor.Color.Secondary
        };
    }

    private string FormatDate(DateTime date)
    {
        var timeSpan = DateTime.Now - date;

        if (timeSpan.Days > 0)
        {
            return $"{timeSpan.Days} day{(timeSpan.Days > 1 ? "s" : "")} ago";
        }
        else if (timeSpan.Hours > 0)
        {
            return $"{timeSpan.Hours} hour{(timeSpan.Hours > 1 ? "s" : "")} ago";
        }
        else if (timeSpan.Minutes > 0)
        {
            return $"{timeSpan.Minutes} minute{(timeSpan.Minutes > 1 ? "s" : "")} ago";
        }
        else
        {
            return "Just now";
        }
    }

    private string GetExcerpt(string content)
    {
        if (string.IsNullOrEmpty(content))
            return "";

        const int maxLength = 150;
        if (content.Length <= maxLength)
            return content;

        return content.Substring(0, maxLength) + "...";
    }

    // Helper methods for CSS classes
    private string GetAnnouncementCardClass(string priority) => $"announcement-card {GetPriorityClass(priority)}";

    private string GetFullAnnouncementCardClass(string priority)
    {
        return $"{GetAnnouncementCardClass(priority)} mud-elevation-3 mud-rounded p-3 mb-4";
    }

    private string GetPriorityClass(string priority)
    {
        return (priority ?? "").ToLower() switch
        {
            "high" => "priority-high",
            "medium" => "priority-medium",
            "low" => "priority-low",
            _ => "priority-normal"
        };
    }

    private async Task OnShowModalClick()
    {
        isModalVisible = true;
    }

    private async Task OnHideModalClick()
    {
        isModalVisible = false;
        selectedAnnouncement = null;
    }
}