@using MudBlazor.Utilities;
@using MudBlazor.Components;
@using System.Security.Claims
@page "/user/lms/messages"
@inject LMS.UI.Shared.Abstractions.IAuthenticationService AuthenticationService
@inject HttpClient HttpClient
@inject ISnackbar Snackbar


<PageTitle>Messages - LMS</PageTitle>

<div class="container-fluid">
    <MudToolBar
        Class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <MudText Typo="Typo.h5" Class="h2">
            <MudIcon Icon="@Icons.Material.Filled.Mail" Class="me-2" />Messages
        </MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ShowComposeModal">
            <MudIcon Icon="@Icons.Material.Filled.Add" Class="me-1" />Compose
        </MudButton>
    </MudToolBar>

    <div class="row">
        <!-- Message List -->
        <div class="col-md-4 border-end">
            <div class="mb-3">
                <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined" FullWidth="true">
                    <MudButton OnClick='() => SwitchFolder("inbox")'
                        Variant="@(currentFolder == "inbox" ? Variant.Filled : Variant.Outlined)">
                        <MudIcon Icon="@Icons.Material.Filled.Inbox" Class="me-1" />Inbox (@unreadCount)
                    </MudButton>

                    <MudButton OnClick='() => SwitchFolder("sent")'
                        Variant="@(currentFolder == "sent" ? Variant.Filled : Variant.Outlined)">
                        <MudIcon Icon="@Icons.Material.Filled.Send" Class="me-1" />Sent
                    </MudButton>
                </MudButtonGroup>
            </div>

            @if (isLoadingMessages)
            {
                <div class="text-center py-3">
                    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                </div>
            }
            else if (filteredMessages?.Any() == true)
            {
                <MudList T="MessageModel" Clickable="true">
                    @foreach (var message in filteredMessages)
                    {
                        <MudListItem T="MessageModel" OnClick="() => SelectMessage(message)"
                            Class="@(selectedMessage?.Id == message.Id ? "mud-selected" : ( !message.IsRead && currentFolder == "inbox" ? "mud-primary-text" : ""))">
                            <div class="d-flex w-100 justify-content-between">
                                <MudText Typo="Typo.subtitle1"
                                    Class="@(selectedMessage?.Id == message.Id || (!message.IsRead && currentFolder == "inbox") ? "fw-bold" : "")">
                                    @if (currentFolder == "inbox")
                                    {
                                        @message.FromUserName
                                    }
                                    else
                                    {
                                        @message.ToUserName
                                    }
                                </MudText>
                                <MudText Typo="Typo.caption"
                                    Class="@(selectedMessage?.Id == message.Id || (!message.IsRead && currentFolder == "inbox") ? "fw-bold" : "")">
                                    @message.SentAt.ToString("MMM dd")
                                </MudText>
                            </div>
                            <MudText Typo="Typo.body2"
                                Class="@(selectedMessage?.Id == message.Id || (!message.IsRead && currentFolder == "inbox") ? "fw-bold" : "")">
                                @message.Subject</MudText>
                            <MudText Typo="Typo.caption" Class="text-muted">
                                @if (message.Content.Length > 60)
                                {
                                    @(message.Content.Substring(0, 60) + "...")
                                }
                                else
                                {
                                    @message.Content
                                }
                            </MudText>
                            @if (!message.IsRead && currentFolder == "inbox")
                            {
                                <MudChip T="string" Color="Color.Primary" Size="Size.Small" Class="ms-2">New</MudChip>
                            }
                            @if (GetMessagePriorityIconName(message.Priority) is string iconName)
                            {
                                <MudIcon Icon="@iconName" Class="ms-2" />
                            }
                        </MudListItem>
                    }
                </MudList>
            }
            else
            {
                <div class="text-center py-5">
                    <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="Size.Large" Class="text-muted mb-3" />
                    <MudText Typo="Typo.h5" Class="text-muted">No messages in @currentFolder</MudText>
                </div>
            }
        </div>

        <!-- Message Content -->
        <div class="col-md-8">
            @if (selectedMessage != null)
            {
                <MudChat Style="height: 100%;" Class="d-flex flex-column">
                    <MudChatBubble Text="@((MarkupString)selectedMessage.Content.Replace("\n", "<br>"))"
                        Time="@selectedMessage.SentAt.ToString("MMM dd, yyyy 'at' h:mm tt")"
                        Origin="@(selectedMessage.FromUserId == currentUserId ? MudBlazor.Origin.TopRight : MudBlazor.Origin.TopLeft)"
                        Color="@(selectedMessage.FromUserId == currentUserId ? Color.Primary : Color.Secondary)">
                        @* ChildContent for main message *@
                        <div class="d-flex align-items-center mb-2">
                            <MudAvatar Color="Color.Dark" Variant="Variant.Outlined" Class="me-2">
                                <MudText Typo="Typo.h6">@selectedMessage.FromUserName?.FirstOrDefault()</MudText>
                            </MudAvatar>
                            <MudText Typo="Typo.subtitle1">@(selectedMessage.FromUserName ?? "Unknown")</MudText>
                        </div>
                        @if (selectedMessage.Attachments?.Any() == true)
                        {
                            <div class="mt-3">
                                <MudText Typo="Typo.subtitle1">Attachments:</MudText>
                                @foreach (var attachment in selectedMessage.Attachments)
                                {
                                    <div class="d-flex align-items-center mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.AttachFile" Class="me-2" />
                                        <MudLink Href="#" Class="text-decoration-none">@attachment.FileName</MudLink>
                                        <MudText Typo="Typo.caption" Class="text-muted ms-2">
                                            (@FormatFileSize(attachment.FileSize))
                                        </MudText>
                                    </div>
                                }
                            </div>
                        }
                        <MudCardActions Class="pa-0">
                            <MudButton Variant="Variant.Text" Color="Color.Inherit" Size="Size.Small"
                                OnClick="ReplyToMessage">
                                <MudIcon Icon="@Icons.Material.Filled.Reply" Class="me-1" />Reply
                            </MudButton>
                            <MudButton Variant="Variant.Text" Color="Color.Inherit" Size="Size.Small"
                                OnClick="DeleteMessage">
                                <MudIcon Icon="@Icons.Material.Filled.Delete" Class="me-1" />Delete
                            </MudButton>
                        </MudCardActions>
                    </MudChatBubble>

                    @if (selectedMessage.Replies?.Any() == true)
                    {
                        @foreach (var reply in selectedMessage.Replies)
                        {
                            <MudChatBubble Text="@((MarkupString)reply.Content.Replace("\n", "<br>"))"
                                Time="@reply.SentAt.ToString("MMM dd, yyyy 'at' h:mm tt")"
                                Origin="@(reply.FromUserId == currentUserId ? MudBlazor.Origin.TopRight : MudBlazor.Origin.TopLeft)"
                                Color="@(reply.FromUserId == currentUserId ? Color.Primary : Color.Secondary)">
                                @* ChildContent for reply *@
                                <div class="d-flex align-items-center mb-2">
                                    <MudAvatar Color="Color.Dark" Variant="Variant.Outlined" Class="me-2">
                                        <MudText Typo="Typo.h6">@reply.FromUserName?.FirstOrDefault()</MudText>
                                    </MudAvatar>
                                    <MudText Typo="Typo.subtitle1">@(reply.FromUserName ?? "Unknown")</MudText>
                                </div>
                            </MudChatBubble>
                        }
                    }
                </MudChat>
            }
            else
            {
                <div class="text-center py-5">
                    <MudIcon Icon="@Icons.Material.Filled.MailOutline" Size="Size.Large" Class="text-muted mb-3" />
                    <h4 class="text-muted">Select a message</h4>
                    <p class="text-muted">Choose a message from the list to read its content</p>
                </div>
            }
        </div>
    </div>
</div>



<!-- Compose Message Modal -->
<MudDialog @bind-IsVisible="@isComposeModalVisible" Options="@dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">@(replyToMessage != null ? "Reply to: " + replyToMessage.Subject : "Compose Message")
        </MudText>
    </TitleContent>
    <DialogContent>
        <EditForm Model="@newMessage" OnValidSubmit="SendMessage">
            <MudAlert Severity="Severity.Error" Class="mb-3" Visible="@(!string.IsNullOrEmpty(statusMessage))">
                <MudText>@statusMessage</MudText>
            </MudAlert>

            @if (replyToMessage == null)
            {
                <MudTextField T="string" Label="To" Variant="Variant.Text" @bind-Value="toUserSearch"
                    Placeholder="Search for a user..." />
                @if (searchedUsers?.Any() == true)
                {
                    <MudList T="UserModel" Clickable="true">
                        @foreach (var user in searchedUsers.Take(5))
                        {
                            <MudListItem T="UserModel" OnClick="() => SelectRecipient(user)">
                                @user.UserName (@user.Email)
                            </MudListItem>
                        }
                    </MudList>
                }
            }

            <MudTextField T="string" Label="Subject" Variant="Variant.Text" @bind-Value="newMessage.Subject"
                Required="true" RequiredError="Subject is required!" />

            <MudAutocomplete T="int" Label="Priority" Variant="Variant.Text" @bind-Value="newMessage.Priority"
                SearchFunc="@SearchPriorityOptions"
                ToStringFunc="@(p => priorityOptions.FirstOrDefault(x => x.Value == p)?.DisplayName ?? string.Empty)"
                Clearable="false" Placeholder="Select priority">
                <ItemTemplate Context="priorityContext">
                    <MudText>@(priorityOptions.FirstOrDefault(o => o.Value == priorityContext)?.DisplayName)</MudText>
                </ItemTemplate>
            </MudAutocomplete>

            <MudTextField T="string" Label="Message" Variant="Variant.Text" Lines="6" @bind-Value="newMessage.Content"
                Required="true" RequiredError="Message content is required!" />

            <MudDialogActions>
                <MudButton Color="Color.Secondary" OnClick="HideComposeModal">Cancel</MudButton>
                <MudButton Color="Color.Primary" ButtonType="ButtonType.Submit" Disabled="@isSending">
                    Send Message
                </MudButton>
            </MudDialogActions>
        </EditForm>
    </DialogContent>
</MudDialog>

@code {
    private bool isLoadingMessages = true;
    private bool isSending = false;
    private string statusMessage = "";
    private string currentFolder = "inbox";
    private string? currentUserId;
    private string toUserSearch = "";

    private List<MessageModel>? inboxMessages;
    private List<MessageModel>? sentMessages;
    private List<MessageModel>? filteredMessages;
    private List<UserModel>? searchedUsers;
    private MessageModel? selectedMessage;
    private MessageModel? replyToMessage;

    private CreateMessageRequest newMessage = new();
    private int unreadCount = 0;

    private bool isComposeModalVisible = false;
    private DialogOptions dialogOptions = new() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

    private List<PriorityOption> priorityOptions = new(){
new PriorityOption { Value = 1, DisplayName = "Low" },
new PriorityOption { Value = 2, DisplayName = "Normal" },
new PriorityOption { Value = 3, DisplayName = "High" },
new PriorityOption { Value = 4, DisplayName = "Urgent" }
};

    private Task<IEnumerable<int>> SearchPriorityOptions(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult(priorityOptions.Select(x => x.Value));
        return Task.FromResult(priorityOptions.Where(x => x.DisplayName.Contains(value,
        StringComparison.InvariantCultureIgnoreCase)).Select(x => x.Value));
    }

    public class PriorityOption
    {
        public int Value { get; set; }
        public string DisplayName { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadMessages();
    }

    private async Task LoadMessages()
    {
        try
        {
            isLoadingMessages = true;
            var user = await AuthenticationService.GetUser();
            if (user.Identity?.IsAuthenticated == true)
            {
                currentUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

                if (!string.IsNullOrEmpty(currentUserId))
                {
                    // Load inbox and sent messages via HTTP endpoints
                    var inboxResponse = await HttpClient.GetAsync($"/api/messages/user/{currentUserId}/inbox");
                    if (inboxResponse.IsSuccessStatusCode)
                    {
                        inboxMessages = await inboxResponse.Content.ReadFromJsonAsync<List<MessageModel>>() ?? new List<MessageModel>();
                    }

                    var sentResponse = await HttpClient.GetAsync($"/api/messages/user/{currentUserId}/sent");
                    if (sentResponse.IsSuccessStatusCode)
                    {
                        sentMessages = await sentResponse.Content.ReadFromJsonAsync<List<MessageModel>>() ?? new List<MessageModel>();
                    }

                    unreadCount = inboxMessages?.Count(m => !m.IsRead) ?? 0;

                    FilterMessages();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading messages: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoadingMessages = false;
        }
    }

    private void FilterMessages()
    {
        filteredMessages = currentFolder switch
        {
            "sent" => sentMessages,
            _ => inboxMessages
        };
    }

    private void SwitchFolder(string folder)
    {
        currentFolder = folder;
        FilterMessages();
        selectedMessage = null;
    }

    private async Task SelectMessage(MessageModel message)
    {
        selectedMessage = message;

        // Mark as read if it's an inbox message and not already read
        if (currentFolder == "inbox" && !message.IsRead && currentUserId != null)
        {
            try
            {
                var response = await HttpClient.PutAsync($"/api/messages/{message.Id}/read?userId={currentUserId}", null);
                if (response.IsSuccessStatusCode)
                {
                    message.ReadAt = DateTime.UtcNow;
                    unreadCount = Math.Max(0, unreadCount - 1);
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error marking message as read: {ex.Message}", Severity.Error);
            }
        }
    }

    private void ShowComposeModal()
    {
        replyToMessage = null;
        newMessage = new CreateMessageRequest();
        toUserSearch = "";
        searchedUsers = null;
        isComposeModalVisible = true;
    }

    private void ReplyToMessage()
    {
        if (selectedMessage == null) return;

        replyToMessage = selectedMessage;
        newMessage = new CreateMessageRequest
        {
            Subject = selectedMessage.Subject.StartsWith("Re: ") ? selectedMessage.Subject : $"Re: {selectedMessage.Subject}",
            ToUserId = selectedMessage.FromUserId,
            ParentMessageId = selectedMessage.Id,
            Priority = 2
        };
        toUserSearch = "";
        searchedUsers = null;
        isComposeModalVisible = true;
    }

    private void HideComposeModal()
    {
        isComposeModalVisible = false;
        replyToMessage = null;
        newMessage = new CreateMessageRequest();
        toUserSearch = "";
        searchedUsers = null;
    }

    private async Task SendMessage()
    {
        if (currentUserId == null) return;

        try
        {
            isSending = true;
            var response = await HttpClient.PostAsJsonAsync($"/api/messages?senderId={currentUserId}", newMessage);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Message sent successfully!", Severity.Success);
                HideComposeModal();
                await LoadMessages();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                statusMessage = $"Failed to send message: {error}";
                Snackbar.Add(statusMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error sending message: {ex.Message}";
            Snackbar.Add(statusMessage, Severity.Error);
        }
        finally
        {
            isSending = false;
        }
    }

    private async Task DeleteMessage()
    {
        if (selectedMessage == null || currentUserId == null) return;

        try
        {
            var response = await HttpClient.DeleteAsync($"/api/messages/{selectedMessage.Id}?userId={currentUserId}");
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Message deleted successfully!", Severity.Success);
                selectedMessage = null;
                await LoadMessages();
            }
            else
            {
                Snackbar.Add("Failed to delete message", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting message: {ex.Message}", Severity.Error);
        }
    }

    private void SelectRecipient(UserModel user)
    {
        newMessage.ToUserId = user.Id;
        toUserSearch = user.UserName;
        searchedUsers = null;
    }

    // Returns a MudBlazor icon string for the given priority
    private string GetMessagePriorityIconName(string priority)
    {
        return priority switch
        {
            "High" => Icons.Material.Filled.PriorityHigh,
            "Urgent" => Icons.Material.Filled.CrisisAlert,
            _ => Icons.Material.Filled.MailOutline
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}
