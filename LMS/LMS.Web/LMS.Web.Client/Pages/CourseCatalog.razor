@using BlazorBootstrap
@page "/user/lms/courses/catalog"
@inject HttpClient HttpClient

<div class="course-catalog-layout">
    <!-- Categories Sidebar -->
    <div class="catalog-sidebar">
        <div class="sidebar-header">
            <h5 class="sidebar-title">Categories</h5>
        </div>
        <div class="sidebar-content">
            <ListGroup class="category-list">
                <ListGroupItem class="@(selectedCategory == "all" ? "active" : "")" @onclick='() => SelectCategory("all")'>
                    <div class="category-icon">
                        <Icon Name="IconName.BookmarkFill" />
                    </div>
                    <span class="category-text">All Courses</span>
                </ListGroupItem>
                <ListGroupItem class="@(selectedCategory == "development" ? "active" : "")" @onclick='() => SelectCategory("development")'>
                    <div class="category-icon">
                        <Icon Name="IconName.Laptop" />
                    </div>
                    <span class="category-text">Development</span>
                </ListGroupItem>
                <ListGroupItem class="@(selectedCategory == "business" ? "active" : "")" @onclick='() => SelectCategory("business")'>
                    <div class="category-icon">
                        <Icon Name="IconName.GraphUp" />
                    </div>
                    <span class="category-text">Business</span>
                </ListGroupItem>
                <ListGroupItem class="@(selectedCategory == "design" ? "active" : "")" @onclick='() => SelectCategory("design")'>
                    <div class="category-icon">
                        <Icon Name="IconName.PaintBucket" />
                    </div>
                    <span class="category-text">Design</span>
                </ListGroupItem>
                <ListGroupItem class="@(selectedCategory == "security" ? "active" : "")" @onclick='() => SelectCategory("security")'>
                    <div class="category-icon">
                        <Icon Name="IconName.ShieldCheck" />
                    </div>
                    <span class="category-text">Security</span>
                </ListGroupItem>
            </ListGroup>

            <div class="filters-section">
                <h6 class="filter-title">Filters</h6>
                <div class="filter-group">
                    <span class="filter-label">Level</span>
                    <div class="filter-options">
                        <CheckboxInput @bind-value="filters.Beginner" @onchange="ApplyFilters">Beginner</CheckboxInput>
                        <CheckboxInput @bind-value="filters.Intermediate" @onchange="ApplyFilters">Intermediate</CheckboxInput>
                        <CheckboxInput @bind-value="filters.Advanced" @onchange="ApplyFilters">Advanced</CheckboxInput>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="catalog-main">
        <!-- Header -->
        <div class="catalog-header">
            <div class="header-info">
                <h3 class="page-title">Course Catalog</h3>
                <p class="page-subtitle">Discover and learn new skills</p>
            </div>
            <div class="header-actions">
                <div class="search-container">
                    <InputText @bind-Value="searchQuery" @bind-Value:event="oninput" Placeholder="Search courses, instructors, topics..." class="form-control" />
                </div>
                <div class="sort-dropdown">
                    <Dropdown>
                        <DropdownToggleButton Color="ButtonColor.Secondary" Outline="true">
                            <Icon Name="IconName.Funnel" class="me-1" /> @GetSortDisplayText()
                        </DropdownToggleButton>
                        <DropdownMenu>
                            <DropdownItem @onclick='() => SetSort("popular")' Active="@(sortBy == "popular")">Most Popular</DropdownItem>
                            <DropdownItem @onclick='() => SetSort("newest")' Active="@(sortBy == "newest")">Newest</DropdownItem>
                            <DropdownItem @onclick='() => SetSort("alphabetical")' Active="@(sortBy == "alphabetical")">A-Z</DropdownItem>
                            <DropdownItem @onclick='() => SetSort("level")' Active="@(sortBy == "level")">By Level</DropdownItem>
                        </DropdownMenu>
                    </Dropdown>
                </div>
            </div>
        </div>

        <!-- Course Grid -->
        <div class="courses-content">
            <div class="course-grid">
                @if (filteredCourses.Any())
                {
                    @foreach (var course in filteredCourses)
                    {
                        <CourseCard Course="course" IsBookmarked="bookmarkedCourses.Contains(course.Id)" OnBookmark="ToggleBookmark" />
                    }
                }
                else
                {
                    <div class="no-courses-found">
                        <Icon Name="IconName.Search" Size="IconSize.x3" />
                        <h5>No courses found</h5>
                        <p>Try adjusting your search criteria or filters.</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>


@code {
    // State variables
    private string selectedCategory = "all";
    private string searchQuery = "";
    private string sortBy = "popular";
    private FilterModel filters = new();
    private HashSet<int> bookmarkedCourses = new();
    private List<CourseModel> filteredCourses = new();
    private List<CourseModel> allCourses = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCourses();
    }

    private async Task LoadCourses()
    {
        try
        {
            isLoading = true;
            var response = await HttpClient.GetAsync("/api/courses");
            if (response.IsSuccessStatusCode)
            {
                allCourses = await response.Content.ReadFromJsonAsync<List<CourseModel>>() ?? new();
                ApplyFilters();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading courses: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SelectCategory(string category)
    {
        selectedCategory = category;
        ApplyFilters();
    }

    private void SetSort(string sortType)
    {
        sortBy = sortType;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var courses = allCourses.AsQueryable();

        // Apply category filter
        if (selectedCategory != "all")
        {
            courses = courses.Where(c => c.Categories != null && c.Categories.Contains(selectedCategory));
        }

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            courses = courses.Where(c =>
            c.Title.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
            c.Description.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
            c.InstructorName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase));
        }

        // Apply level filters
        if (filters.HasAnyLevelFilter())
        {
            courses = courses.Where(c =>
            (filters.Beginner && c.Level == "Beginner") ||
            (filters.Intermediate && c.Level == "Intermediate") ||
            (filters.Advanced && c.Level == "Advanced"));
        }

        // Apply sorting
        courses = sortBy switch
        {
            "popular" => courses.OrderByDescending(c => c.EnrollmentCount),
            "newest" => courses.OrderByDescending(c => c.StartDate),
            "alphabetical" => courses.OrderBy(c => c.Title),
            "level" => courses.OrderBy(c => c.Level == "Beginner" ? 1 : c.Level == "Intermediate" ? 2 : 3),
            _ => courses.OrderByDescending(c => c.EnrollmentCount)
        };

        filteredCourses = courses.ToList();
        StateHasChanged();
    }

    private void ToggleBookmark(int courseId)
    {
        if (bookmarkedCourses.Contains(courseId))
        {
            bookmarkedCourses.Remove(courseId);
        }
        else
        {
            bookmarkedCourses.Add(courseId);
        }
    }

    private string FormatDuration(TimeSpan duration)
    {
        var hours = (int)duration.TotalHours;
        var minutes = duration.Minutes;

        if (hours > 0)
        {
            return minutes > 0 ? $"{hours}h {minutes}m" : $"{hours}h";
        }
        return $"{minutes}m";
    }

    private string GetSortDisplayText()
    {
        return sortBy switch
        {
            "popular" => "Most Popular",
            "newest" => "Newest",
            "alphabetical" => "A-Z",
            "level" => "By Level",
            _ => "Sort by"
        };
    }

    // Helper classes
    public class FilterModel
    {
        public bool Beginner { get; set; }
        public bool Intermediate { get; set; }
        public bool Advanced { get; set; }

        public bool HasAnyLevelFilter() => Beginner || Intermediate || Advanced;
    }
}