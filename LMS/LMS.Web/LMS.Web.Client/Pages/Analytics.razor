@page "/user/lms/analytics"
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject HttpClient HttpClient
@inject IJSRuntime JSRuntime

<div class="analytics-layout">
    <!-- Analytics Sidebar -->
    <div class="analytics-sidebar">
        <div class="sidebar-header">
            <h5 class="sidebar-title">Analytics</h5>
        </div>
        <div class="sidebar-content">
            <div class="analytics-nav">
                <div class="nav-item @(selectedView == "overview" ? "active" : "")" @onclick='() => SelectView("overview")'>
                    <div class="nav-icon">
                        <i class="bi bi-speedometer2"></i>
                    </div>
                    <span class="nav-text">Overview</span>
                </div>
                <div class="nav-item @(selectedView == "progress" ? "active" : "")" @onclick='() => SelectView("progress")'>
                    <div class="nav-icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <span class="nav-text">Progress</span>
                </div>
                <div class="nav-item @(selectedView == "performance" ? "active" : "")" @onclick='() => SelectView("performance")'>
                    <div class="nav-icon">
                        <i class="bi bi-trophy"></i>
                    </div>
                    <span class="nav-text">Performance</span>
                </div>
                <div class="nav-item @(selectedView == "activity" ? "active" : "")" @onclick='() => SelectView("activity")'>
                    <div class="nav-icon">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <span class="nav-text">Activity</span>
                </div>
            </div>
            
            <div class="filters-section">
                <h6 class="filter-title">Time Period</h6>
                <div class="filter-group">
                    <div class="filter-options">
                        <label class="filter-option @(selectedPeriod == "week" ? "active" : "")" @onclick='() => SelectPeriod("week")'>
                            <span>This Week</span>
                        </label>
                        <label class="filter-option @(selectedPeriod == "month" ? "active" : "")" @onclick='() => SelectPeriod("month")'>
                            <span>This Month</span>
                        </label>
                        <label class="filter-option @(selectedPeriod == "all" ? "active" : "")" @onclick='() => SelectPeriod("all")'>
                            <span>All Time</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Analytics Area -->
    <div class="analytics-main">
        <!-- Header -->
        <div class="analytics-header">
            <div class="header-info">
                <h3 class="page-title">Learning Analytics</h3>
                <p class="page-subtitle">Track your learning progress and performance</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline-primary refresh-btn" @onclick="RefreshAnalytics">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </div>
        
        <!-- Analytics Content -->
        <div class="analytics-content">
            @if (isLoading)
            {
                <div class="loading-container">
                    <div class="spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading analytics...</span>
                        </div>
                    </div>
                    <p class="loading-text">Loading your analytics...</p>
                </div>
            }
            else
            {
                @if (selectedView == "overview")
                {
                    <!-- KPI Cards -->
                    <div class="kpi-grid">
                        <div class="kpi-card primary">
                            <div class="kpi-icon">
                                <i class="bi bi-graph-up-arrow"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">@overallProgress.ToString("F1")%</div>
                                <div class="kpi-label">Overall Progress</div>
                            </div>
                        </div>
                        
                        <div class="kpi-card success">
                            <div class="kpi-icon">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">@completedCourses</div>
                                <div class="kpi-label">Completed Courses</div>
                            </div>
                        </div>
                        
                        <div class="kpi-card info">
                            <div class="kpi-icon">
                                <i class="bi bi-clock"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">@totalStudyHours</div>
                                <div class="kpi-label">Study Hours</div>
                            </div>
                        </div>
                        
                        <div class="kpi-card warning">
                            <div class="kpi-icon">
                                <i class="bi bi-star"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">@averageScore.ToString("F1")%</div>
                                <div class="kpi-label">Average Score</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Row -->
                    <div class="charts-row">
                        <!-- Course Progress Chart -->
                        <div class="chart-card large">
                            <div class="card-header">
                                <h6 class="card-title">
                                    <i class="bi bi-bar-chart"></i>
                                    Course Progress Overview
                                </h6>
                            </div>
                            <div class="card-content">
                                @if (enrollments?.Any() == true)
                                {
                                    @foreach (var enrollment in enrollments.Take(5))
                                    {
                                        var courseProgress = GetCourseProgress(enrollment.Id);
                                        <div class="progress-item">
                                            <div class="progress-header">
                                                <span class="course-name">@enrollment.CourseTitle</span>
                                                <span class="progress-value">@courseProgress.ToString("F1")%</span>
                                            </div>
                                            <div class="progress-bar-container">
                                                <div class="progress-bar @GetProgressBarClass(courseProgress)" 
                                                     style="width: @courseProgress%"></div>
                                            </div>
                                            <div class="progress-meta">
                                                <span class="modules-info">
                                                    @GetCompletedModules(enrollment.Id) / @GetTotalModules(enrollment.Id) modules
                                                </span>
                                                <span class="enrollment-date">
                                                    Enrolled: @enrollment.EnrolledAt.ToString("MMM dd, yyyy")
                                                </span>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="empty-state">
                                        <i class="bi bi-book"></i>
                                        <p>No course enrollments found.</p>
                                        <a href="/user/lms/courses/catalog" class="btn btn-primary">Browse Courses</a>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Activity Summary -->
                        <div class="chart-card small">
                            <div class="card-header">
                                <h6 class="card-title">
                                    <i class="bi bi-activity"></i>
                                    Activity Summary
                                </h6>
                            </div>
                            <div class="card-content center">
                                <div class="circular-progress">
                                    <div class="circle-progress" style="--progress: @overallProgress">
                                        <span class="progress-text">@overallProgress.ToString("F0")%</span>
                                    </div>
                                    <div class="progress-label">Overall Progress</div>
                                </div>
                                
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div class="stat-value">@totalLessonsCompleted</div>
                                        <div class="stat-label">Lessons</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">@totalModulesCompleted</div>
                                        <div class="stat-label">Modules</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">@currentStreak</div>
                                        <div class="stat-label">Day Streak</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">@activeDays</div>
                                        <div class="stat-label">Active Days</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                
                @if (selectedView == "activity")
                {
                    <!-- Recent Activity -->
                    <div class="activity-section">
                        <div class="activity-card">
                            <div class="card-header">
                                <h6 class="card-title">
                                    <i class="bi bi-clock-history"></i>
                                    Recent Activity
                                </h6>
                            </div>
                            <div class="card-content">
                                @if (recentActivities?.Any() == true)
                                {
                                    <div class="activity-timeline">
                                        @foreach (var activity in recentActivities.Take(10))
                                        {
                                            <div class="timeline-item">
                                                <div class="timeline-marker @GetActivityColor(activity.Type)"></div>
                                                <div class="timeline-content">
                                                    <div class="activity-header">
                                                        <strong class="activity-title">@activity.Description</strong>
                                                        <span class="activity-time">@activity.Timestamp.ToString("MMM dd, HH:mm")</span>
                                                    </div>
                                                    <div class="activity-course">@activity.CourseTitle</div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="empty-state">
                                        <i class="bi bi-clock-history"></i>
                                        <p>No recent activity found.</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
                
                @if (selectedView == "performance")
                {
                    <!-- Performance Metrics -->
                    <div class="performance-section">
                        <div class="performance-card">
                            <div class="card-header">
                                <h6 class="card-title">
                                    <i class="bi bi-graph-up"></i>
                                    Performance Metrics
                                </h6>
                            </div>
                            <div class="card-content">
                                @if (performanceMetrics?.Any() == true)
                                {
                                    @foreach (var metric in performanceMetrics)
                                    {
                                        <div class="metric-item">
                                            <div class="metric-header">
                                                <span class="metric-name">@metric.Name</span>
                                                <span class="metric-badge @GetMetricBadgeClass(metric.Value)">
                                                    @metric.Value.ToString("F1")@metric.Unit
                                                </span>
                                            </div>
                                            <div class="metric-progress">
                                                <div class="progress-bar @GetMetricProgressClass(metric.Value)" 
                                                     style="width: @GetMetricPercentage(metric.Value, metric.MaxValue)%"></div>
                                            </div>
                                            <div class="metric-description">@metric.Description</div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="empty-state">
                                        <i class="bi bi-graph-up"></i>
                                        <p>Performance data will appear as you progress through courses.</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private List<EnrollmentModel>? enrollments;
    private List<ActivityModel> recentActivities = new();
    private List<MetricModel> performanceMetrics = new();
    private bool isLoading = true;
    private string selectedPeriod = "month";
    private string selectedView = "overview";
    private double overallProgress = 0;
    private int completedCourses = 0;
    private int totalStudyHours = 0;
    private double averageScore = 0;
    private int totalLessonsCompleted = 0;
    private int totalModulesCompleted = 0;
    private int currentStreak = 0;
    private int activeDays = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadAnalytics();
    }

    private async Task LoadAnalytics()
    {
        try
        {
            isLoading = true;
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                var currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                
                if (!string.IsNullOrEmpty(currentUserId))
                {
                    // Load user enrollments via HTTP endpoint
                    var enrollmentsResponse = await HttpClient.GetAsync($"/api/enrollments/user/{currentUserId}/enrollments");
                    if (enrollmentsResponse.IsSuccessStatusCode)
                    {
                        enrollments = await enrollmentsResponse.Content.ReadFromJsonAsync<List<EnrollmentModel>>();
                    }
                    
                    // Calculate analytics
                    await CalculateAnalytics(currentUserId);
                    
                    // Load recent activities (mock data for now)
                    LoadRecentActivities();
                    
                    // Load performance metrics (mock data for now)
                    LoadPerformanceMetrics();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading analytics: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private Task CalculateAnalytics(string userId)
    {
        if (enrollments == null) return Task.CompletedTask;

        var completedEnrollments = enrollments.Where(e => e.ProgressPercentage >= 100).ToList();
        completedCourses = completedEnrollments.Count;

        if (enrollments.Any())
        {
            overallProgress = enrollments.Average(e => e.ProgressPercentage);
            averageScore = enrollments.Where(e => e.FinalGrade.HasValue).Any() 
                ? enrollments.Where(e => e.FinalGrade.HasValue).Average(e => e.FinalGrade!.Value) 
                : 0;
        }

        // Calculate study hours and other metrics (mock calculation)
        totalStudyHours = enrollments.Count * 10; // Mock: 10 hours per enrollment
        totalLessonsCompleted = enrollments.Sum(e => (int)(e.ProgressPercentage / 100 * 20)); // Mock: 20 lessons per course
        totalModulesCompleted = enrollments.Sum(e => (int)(e.ProgressPercentage / 100 * 5)); // Mock: 5 modules per course
        currentStreak = 7; // Mock data
        activeDays = 45; // Mock data
        
        return Task.CompletedTask;
    }

    private void LoadRecentActivities()
    {
        // Mock recent activities
        recentActivities = new List<ActivityModel>
        {
            new() { Type = "lesson", Description = "Completed lesson: Introduction to Programming", CourseTitle = "Programming Basics", Timestamp = DateTime.Now.AddHours(-2) },
            new() { Type = "quiz", Description = "Passed quiz with 85%", CourseTitle = "Data Structures", Timestamp = DateTime.Now.AddHours(-5) },
            new() { Type = "module", Description = "Finished module: Web Development Fundamentals", CourseTitle = "Full Stack Development", Timestamp = DateTime.Now.AddDays(-1) },
            new() { Type = "certificate", Description = "Earned certificate", CourseTitle = "JavaScript Essentials", Timestamp = DateTime.Now.AddDays(-2) },
            new() { Type = "enrollment", Description = "Enrolled in new course", CourseTitle = "Machine Learning Basics", Timestamp = DateTime.Now.AddDays(-3) }
        };
    }

    private void LoadPerformanceMetrics()
    {
        // Mock performance metrics
        performanceMetrics = new List<MetricModel>
        {
            new() { Name = "Completion Rate", Value = overallProgress, Unit = "%", MaxValue = 100, Description = "Average course completion" },
            new() { Name = "Quiz Average", Value = averageScore, Unit = "%", MaxValue = 100, Description = "Average quiz score" },
            new() { Name = "Study Consistency", Value = 85, Unit = "%", MaxValue = 100, Description = "Daily learning consistency" },
            new() { Name = "Engagement Score", Value = 78, Unit = "%", MaxValue = 100, Description = "Course interaction level" }
        };
    }

    private async Task RefreshAnalytics()
    {
        await LoadAnalytics();
    }

    private async Task SelectPeriod(string period)
    {
        selectedPeriod = period;
        await LoadAnalytics();
    }

    private void SelectView(string view)
    {
        selectedView = view;
    }

    private double GetCourseProgress(int enrollmentId)
    {
        var enrollment = enrollments?.FirstOrDefault(e => e.Id == enrollmentId);
        return enrollment?.ProgressPercentage ?? 0;
    }

    private int GetCompletedModules(int enrollmentId)
    {
        var progress = GetCourseProgress(enrollmentId);
        return (int)(progress / 100 * 5); // Mock: 5 modules per course
    }

    private int GetTotalModules(int enrollmentId)
    {
        return 5; // Mock: 5 modules per course
    }

    private string GetProgressBarClass(double progress) => progress switch
    {
        >= 90 => "bg-success",
        >= 70 => "bg-info",
        >= 50 => "bg-warning",
        _ => "bg-danger"
    };

    private string GetActivityColor(string type) => type switch
    {
        "lesson" => "primary",
        "quiz" => "success",
        "module" => "info",
        "certificate" => "warning",
        "enrollment" => "secondary",
        _ => "muted"
    };

    private string GetMetricBadgeClass(double value) => value switch
    {
        >= 90 => "bg-success",
        >= 80 => "bg-info",
        >= 70 => "bg-warning",
        _ => "bg-secondary"
    };

    private string GetMetricProgressClass(double value) => value switch
    {
        >= 90 => "bg-success",
        >= 80 => "bg-info",
        >= 70 => "bg-warning",
        _ => "bg-secondary"
    };

    private double GetMetricPercentage(double value, double maxValue)
    {
        return maxValue > 0 ? (value / maxValue) * 100 : 0;
    }

    // Helper models for analytics
    public class ActivityModel
    {
        public string Type { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string CourseTitle { get; set; } = string.Empty;
        public DateTime Timestamp { get; set; }
    }

    public class MetricModel
    {
        public string Name { get; set; } = string.Empty;
        public double Value { get; set; }
        public string Unit { get; set; } = string.Empty;
        public double MaxValue { get; set; }
        public string Description { get; set; } = string.Empty;
    }
}
