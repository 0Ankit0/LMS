@using BlazorBootstrap;
@page "/user/lms/forums"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Identity
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using System.Net.Http.Json
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<PageTitle>Forums - LMS</PageTitle>

<div class="forums-layout">
    <!-- Course Group Sidebar -->
    <div class="course-group-sidebar">
        <div class="group-list">
            <!-- General Group -->
            <div class="group-item @(selectedGroup == "general" ? "active" : "")"
                 @onclick='() => SelectGroup("general")' title="General Discussion">
                <div class="group-icon general-icon">
                    <Icon Name="IconName.Globe" />
                </div>
            </div>

            <!-- Course Groups -->
            @if (courseGroups != null)
            {
                @foreach (var courseGroup in courseGroups)
                {
                    <div class="group-item @(selectedGroup == courseGroup.CourseName ? "active" : "")"
                         @onclick="() => SelectGroup(courseGroup.CourseName)" title="@courseGroup.CourseName">
                        <div class="group-icon course-icon">
                            <span class="course-initial">@courseGroup.CourseName.FirstOrDefault()</span>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Add Forum Button -->
        <div class="group-item add-forum-button" @onclick="ShowCreateForumModal" title="Create New Forum">
            <div class="group-icon">
                <Icon Name="IconName.PlusLg" />
            </div>
        </div>
    </div>

    <!-- Forum List Sidebar -->
    <div class="forum-list-sidebar">
        @if (!string.IsNullOrEmpty(selectedGroup))
        {
            <div class="forum-header">
                <h4 class="forum-title">
                    @if (selectedGroup == "general")
                    {
                        <Icon Name="IconName.Globe" class="me-2" />
                        <span>General Discussion</span>
                    }
                    else
                    {
                        <Icon Name="IconName.Mortarboard" class="me-2" />
                        <span>@selectedGroup</span>
                    }
                </h4>
                <!-- Search Box -->
                <div class="forum-search-container">
                    <InputText type="text" class="forum-search-input" placeholder="Search forums & topics..."
                           @bind-Value="searchQuery" />
                    <Icon Name="IconName.Search" class="search-icon" />
                </div>
            </div>

            <div class="forum-list">
                @if (selectedGroupForums != null)
                {
                    @foreach (var forum in selectedGroupForums)
                    {
                        <div class="forum-accordion">
                            <div class="forum-item @(selectedForumId == forum.Id ? "active" : "")"
                                 @onclick="() => SelectForum(forum.Id)">
                                <div class="forum-info">
                                    <div class="forum-name">
                                        <Icon Name="IconName.Hash" class="me-2" />
                                        <span>@forum.Title</span>
                                    </div>
                                    <div class="forum-stats">
                                        <small class="text-muted">@forum.TopicCount topics</small>
                                    </div>
                                </div>
                                <div class="forum-actions">
                                    <Button Color="ButtonColor.Secondary" Size="ButtonSize.Small"
                                            @onclick="@(e => ShowNewTopicModal(e, forum.Id))" title="Add new topic">
                                        <Icon Name="IconName.PlusLg" />
                                    </Button>
                                    <Button Color="ButtonColor.Secondary" Size="ButtonSize.Small"
                                            @onclick="@(e => ToggleForumExpansion(e, forum.Id))">
                                        <Icon Name="@(expandedForums.Contains(forum.Id) ? IconName.ChevronUp : IconName.ChevronDown)" />
                                    </Button>
                                </div>
                            </div>

                            @if (expandedForums.Contains(forum.Id) && selectedForumTopics != null)
                            {
                                <div class="topics-dropdown">
                                    @foreach (var topic in selectedForumTopics.Where(t => t.ForumId == forum.Id))
                                    {
                                        <div class="topic-dropdown-item @(selectedTopicId == topic.Id ? "active" : "")"
                                             @onclick="() => SelectTopic(topic.Id)">
                                            <div class="topic-info">
                                                <div class="topic-icon">
                                                    @if (topic.IsLocked)
                                                    {
                                                        <Icon Name="IconName.Lock" class="text-secondary" />
                                                    }
                                                    else
                                                    {
                                                        <Icon Name="IconName.ChatDots" class="text-primary" />
                                                    }
                                                </div>
                                                <div class="topic-details">
                                                    <div class="topic-title">@topic.Title</div>
                                                    <div class="topic-meta">
                                                        <small class="text-muted">@topic.PostCount posts</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        }
        else
        {
            <div class="forum-placeholder">
                <Icon Name="IconName.ChatDots" Size="IconSize.x3" class="text-muted mb-3" />
                <p class="text-muted">Select a group to view forums</p>
            </div>
        }
    </div>

    <!-- Main Discussion Area -->
    <div class="discussion-area">
        @if (selectedForumId.HasValue && selectedForum is not null)
        {
            @if (selectedTopicId.HasValue && selectedTopic is not null)
            {
                <!-- Topic View Header -->
                <div class="discussion-header">
                    <div class="discussion-title">
                        <Button Color="ButtonColor.Secondary" Size="ButtonSize.Small" class="me-2" @onclick="BackToForum" title="Back to Forum">
                            <Icon Name="IconName.ArrowLeft" />
                        </Button>
                        @if (selectedTopic?.IsLocked == true)
                        {
                            <Icon Name="IconName.Lock" class="me-2 text-secondary" />
                        }
                        else
                        {
                            <Icon Name="IconName.ChatDots" class="me-2" />
                        }
                        <span>@selectedTopic?.Title</span>
                    </div>
                    <div class="discussion-actions">
                        <div class="topic-stats me-3">
                            <small class="text-muted">
                                <Icon Name="IconName.ChatLeft" class="me-1" />@selectedTopic?.PostCount posts
                                <span class="ms-2"><Icon Name="IconName.Person" class="me-1" />by @selectedTopic?.CreatedByUserName</span>
                            </small>
                        </div>
                        <Button Color="ButtonColor.Secondary" Size="ButtonSize.Small" class="me-2" title="Search in Topic">
                            <Icon Name="IconName.Search" />
                        </Button>
                        <Dropdown>
                            <DropdownToggleButton Color="ButtonColor.Secondary" Size="ButtonSize.Small">
                                <Icon Name="IconName.ThreeDotsVertical" />
                            </DropdownToggleButton>
                            <DropdownMenu>
                                <DropdownItem>
                                    <Icon Name="IconName.Lock" class="me-2" />Lock Topic
                                </DropdownItem>
                                <DropdownDivider />
                                <DropdownItem Class="text-danger">
                                    <Icon Name="IconName.Trash" class="me-2" />Delete Topic
                                </DropdownItem>
                            </DropdownMenu>
                        </Dropdown>
                    </div>
                </div>

                <!-- Topic Posts - Scrollable -->
                <div class="content-area" id="messagesArea">
                    @if (selectedTopicPosts != null)
                    {
                        @foreach (var post in selectedTopicPosts)
                        {
                            <div class="content-item topic-post">
                                <div class="user-avatar">
                                    <div class="avatar-circle">
                                        <span>@post.AuthorName?.FirstOrDefault()</span>
                                    </div>
                                </div>
                                <div class="content-body post-content">
                                    <div class="content-header">
                                        <span class="author-name">@(post.AuthorName ?? "Unknown")</span>
                                        <span class="post-time">@post.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                                        @if (post.UpdatedAt.HasValue && post.UpdatedAt != post.CreatedAt)
                                        {
                                            <span class="text-muted small">(edited @post.UpdatedAt.Value.ToString("MMM dd, HH:mm"))</span>
                                        }
                                    </div>
                                    <div class="content-text post-text">
                                        @((MarkupString)post.Content.Replace("\n", "<br />"))
                                    </div>
                                    <div class="post-actions">
                                        <Button Color="ButtonColor.Secondary" Size="ButtonSize.Small" title="Like">
                                            <Icon Name="IconName.Heart" class="me-1" />0
                                        </Button>
                                        <Button Color="ButtonColor.Secondary" Size="ButtonSize.Small" @onclick="() => QuotePost(post)" title="Quote">
                                            <Icon Name="IconName.Quote" class="me-1" />Quote
                                        </Button>
                                        @if (currentUserId == post.AuthorId)
                                        {
                                            <Button Color="ButtonColor.Secondary" Size="ButtonSize.Small" @onclick="() => EditPost(post)" title="Edit">
                                                <Icon Name="IconName.Pencil" class="me-1" />Edit
                                            </Button>
                                            <Button Color="ButtonColor.Danger" Size="ButtonSize.Small" @onclick="() => DeletePost(post)" title="Delete">
                                                <Icon Name="IconName.Trash" class="me-1" />Delete
                                            </Button>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>

                <!-- Quick Reply - Sticky Bottom -->
                @if (selectedTopic?.IsLocked != true)
                {
                    <div class="input-area">
                        @if (!string.IsNullOrEmpty(quotedText))
                        {
                            <div class="quoted-text">
                                <div class="quote-header">
                                    <span>Replying to @quotedAuthor:</span>
                                    <Button Color="ButtonColor.Secondary" Size="ButtonSize.Small" @onclick="ClearQuote">
                                        <Icon Name="IconName.X" />
                                    </Button>
                                </div>
                                <div class="quote-content">@quotedText</div>
                            </div>
                        }
                        <div class="input-container">
                            <InputText type="text" class="message-input" placeholder="@($"Reply to {selectedTopic?.Title}...")"
                                   @bind-value="newTopicReply" @onkeypress="HandleTopicReplyKeyPress" />
                            <Button Color="ButtonColor.Primary" class="send-button" @onclick="SendTopicReply"
                                    disabled="@string.IsNullOrWhiteSpace(newTopicReply)">
                                <Icon Name="IconName.Send" />
                            </Button>
                        </div>
                    </div>
                }
            }
            else
            {
                <!-- Forum Topics View -->
                <div class="discussion-header">
                    <div class="discussion-title">
                        <Icon Name="IconName.Hash" class="me-2" />
                        <span>@selectedForum.Title</span>
                    </div>
                    <div class="discussion-actions">
                        <div class="forum-stats me-3">
                            <small class="text-muted">
                                <Icon Name="IconName.List" class="me-1" />@selectedForum.TopicCount topics
                                <span class="ms-2"><Icon Name="IconName.People" class="me-1" />@(selectedForumTopics?.SelectMany(t => new[]
                                                                { t.CreatedByUserId }).Distinct().Count() ?? 0) contributors</span>
                            </small>
                        </div>
                        <Button Color="ButtonColor.Secondary" Size="ButtonSize.Small" class="me-2" title="Search Topics">
                            <Icon Name="IconName.Search" />
                        </Button>
                        <Dropdown>
                            <DropdownToggleButton Color="ButtonColor.Secondary" Size="ButtonSize.Small">
                                <Icon Name="IconName.SortDown" />
                            </DropdownToggleButton>
                            <DropdownMenu>
                                <DropdownItem>
                                    <Icon Name="IconName.Calendar" class="me-2" />Sort by Date
                                </DropdownItem>
                                <DropdownItem>
                                    <Icon Name="IconName.Reply" class="me-2" />Sort by Replies
                                </DropdownItem>
                                <DropdownItem>
                                    <Icon Name="IconName.Person" class="me-2" />Sort by Author
                                </DropdownItem>
                            </DropdownMenu>
                        </Dropdown>
                    </div>
                </div>

                <!-- Topics List -->
                <div class="content-area topics-area" id="topicsArea">
                    @if (selectedForumTopics != null && selectedForumTopics.Any())
                    {
                        @foreach (var topic in selectedForumTopics)
                        {
                            <div class="topic-item" @onclick="() => SelectTopic(topic.Id)">
                                <div class="topic-icon">
                                    @if (topic.IsLocked)
                                    {
                                        <Icon Name="IconName.Lock" class="text-secondary" />
                                    }
                                    else
                                    {
                                        <Icon Name="IconName.ChatDots" class="text-primary" />
                                    }
                                </div>
                                <div class="topic-content">
                                    <div class="topic-header">
                                        <h6 class="topic-title">@topic.Title</h6>
                                        <div class="topic-badges">
                                            @if (topic.IsLocked)
                                            {
                                                <span class="badge bg-secondary">Locked</span>
                                            }
                                        </div>
                                    </div>
                                    <div class="topic-meta">
                                        <span class="topic-author">by <strong>@topic.CreatedByUserName</strong></span>
                                        <span class="topic-date">@topic.CreatedAt.ToString("MMM dd, yyyy")</span>
                                        @if (topic.LastPostAt.HasValue)
                                        {
                                            <span class="topic-last-post">Last: @topic.LastPostAt.Value.ToString("MMM dd, HH:mm")</span>
                                        }
                                    </div>
                                </div>
                                <div class="topic-stats">
                                    <div class="post-count">
                                        <span class="count">@topic.PostCount</span>
                                        <small>posts</small>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="content-placeholder">
                            <Icon Name="IconName.ChatDots" Size="IconSize.x4" class="text-muted mb-3" />
                            <h5 class="text-muted">No Topics Yet</h5>
                            <p class="text-muted">Be the first to start a discussion in this forum!</p>
                        </div>
                    }
                </div>
            }
        }
        else
        {
            <div class="chat-placeholder p-4">
                <Icon Name="IconName.ChatDots" Size="IconSize.x5" class="text-muted mb-4" />
                <h3 class="text-muted mb-2 ">Welcome to Forums</h3>
                <p class="text-muted">Select a forum from the sidebar to view topics and discussions</p>
            </div>
        }
    </div>
</div>

<!-- New Topic Modal -->
<Modal @ref="newTopicModal" Title="Create New Topic">
    <BodyTemplate>
        <EditForm Model="@newTopic" OnValidSubmit="CreateTopic">
            <DataAnnotationsValidator />
            <ValidationSummary class="alert alert-danger" />

            <div class="mb-3">
                <label for="topicTitle" class="form-label fw-semibold">
                    <Icon Name="IconName.PencilSquare" class="me-1" />Topic Title
                </label>
                <InputText id="topicTitle" class="form-control" @bind-Value="newTopic.Title"
                           placeholder="Enter an engaging topic title..." />
                <ValidationMessage For="@(() => newTopic.Title)" />
            </div>

            <div class="mb-3">
                <label for="topicContent" class="form-label fw-semibold">
                    <Icon Name="IconName.TextParagraph" class="me-1" />Initial Post Content
                </label>
                <InputTextArea id="topicContent" class="form-control" rows="6" @bind-Value="newTopic.InitialPost"
                               placeholder="Write the first post for this topic..." />
                <ValidationMessage For="@(() => newTopic.InitialPost)" />
                <div class="form-text">You can use basic formatting: **bold**, *italic*, `code`</div>
            </div>

            <div class="modal-footer border-0 px-0 mt-3">
                <Button Color="ButtonColor.Light" @onclick="HideNewTopicModal">
                    <Icon Name="IconName.XLg" class="me-1" />Cancel
                </Button>
                <Button Color="ButtonColor.Primary" Type="ButtonType.Submit" IsLoading="@isCreatingTopic">
                    <Icon Name="IconName.PlusLg" class="me-1" />
                    <span>Create Topic</span>
                </Button>
            </div>
        </EditForm>
    </BodyTemplate>
</Modal>

<!-- New Post Modal -->
<Modal @ref="newPostModal" Title="@($"Reply to: {selectedTopic?.Title}")">
    <BodyTemplate>
        <EditForm Model="@newPost" OnValidSubmit="CreatePost">
            <DataAnnotationsValidator />
            <ValidationSummary/>

            @if (!string.IsNullOrEmpty(quotedText))
            {
                <div class="quote-preview mb-3">
                    <div class="quote-header">
                        <strong>@quotedAuthor wrote:</strong>
                        <Button Color="ButtonColor.Secondary" Size="ButtonSize.Small" class="ms-2" @onclick="ClearQuote">
                            <Icon Name="IconName.X" />
                        </Button>
                    </div>
                    <div class="quote-body">@quotedText</div>
                </div>
            }

            <div class="mb-3">
                <label for="postContent" class="form-label fw-semibold">
                    <Icon Name="IconName.ChatLeftText" class="me-1" />Your Reply
                </label>
                <InputTextArea id="postContent" class="form-control" rows="8" @bind-Value="newPost.Content"
                          placeholder="Share your thoughts..." />
                <ValidationMessage For="@(() => newPost.Content)" />
                <div class="form-text">You can use basic formatting: **bold**, *italic*, `code`</div>
            </div>

            <div class="modal-footer border-0 px-0">
                <Button Color="ButtonColor.Light" @onclick="HideNewPostModal">
                    <Icon Name="IconName.X" class="me-1" />Cancel
                </Button>
                <Button Color="ButtonColor.Primary" Type="ButtonType.Submit" IsLoading="@isCreatingPost">
                    <Icon Name="IconName.Reply" class="me-1" />
                    <span>Post Reply</span>
                </Button>
            </div>
        </EditForm>
    </BodyTemplate>
</Modal>

<!-- Create Forum Modal -->
<Modal @ref="createForumModal" Title="Create New Forum">
    <BodyTemplate>
        <EditForm Model="@newForum" OnValidSubmit="CreateForum">
            <DataAnnotationsValidator />
            <ValidationSummary class="alert alert-danger" />

            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label for="forumTitle" class="form-label fw-semibold">
                            <Icon Name="IconName.PencilSquare" class="me-1" />Forum Title
                        </label>
                        <InputText id="forumTitle" class="form-control form-control-lg" @bind-Value="newForum.Title"
                                   placeholder="Enter forum title..." />
                        <ValidationMessage For="@(() => newForum.Title)" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="courseId" class="form-label fw-semibold">
                            <Icon Name="IconName.Mortarboard" class="me-1" />Course
                        </label>
                        <InputSelect id="courseId" class="form-select" @bind-Value="newForum.CourseId">
                            <option value="">General Forum</option>
                            @if (availableCourses != null)
                            {
                                @foreach (var course in availableCourses)
                                {
                                    <option value="@course.Id">@course.Title</option>
                                }
                            }
                        </InputSelect>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="forumDescription" class="form-label fw-semibold">
                    <Icon Name="IconName.ChatLeftText" class="me-1" />Description
                </label>
                <InputTextArea id="forumDescription" class="form-control" rows="4" @bind-Value="newForum.Description"
                          placeholder="Describe what this forum is about..." />
                <ValidationMessage For="@(() => newForum.Description)" />
            </div>

            <div class="modal-footer border-0 px-0">
                <Button Color="ButtonColor.Light" @onclick="HideCreateModal">
                    <Icon Name="IconName.X" class="me-1" />Cancel
                </Button>
                <Button Color="ButtonColor.Primary" Type="ButtonType.Submit" IsLoading="@isCreating">
                    <Icon Name="IconName.PlusLg" class="me-1" />
                    <span>Create Forum</span>
                </Button>
            </div>
        </EditForm>
    </BodyTemplate>
</Modal>

@code {
    private bool isCreating = false;
    private Modal? createForumModal;
    private Modal? newTopicModal;
    private Modal? newPostModal;
    private string? currentUserId = "current-user"; // Set a dummy user for demo
    private string newTopicReply = "";
    private string searchQuery = "";

    private bool isCreatingTopic = false;
    private bool isCreatingPost = false;

    private int? selectedTopicId;
    private ForumTopicModel? selectedTopic;
    private List<ForumTopicModel>? selectedForumTopics;
    private List<ForumPostModel>? selectedTopicPosts;
    private string quotedText = "";
    private string quotedAuthor = "";

    private string selectedGroup = "";
    private int? selectedForumId;
    private ForumModel? selectedForum;
    private List<ForumModel>? selectedGroupForums;
    private List<CourseGroup>? courseGroups;
    private HashSet<int> expandedForums = new HashSet<int>();

    private List<ForumModel>? forums;
    private List<CourseModel>? availableCourses;
    private CreateForumRequest newForum = new();
    private CreateForumTopicRequest newTopic = new();
    private CreateForumPostRequest newPost = new();

    public class CourseGroup
    {
        public string CourseName { get; set; } = "";
        public int ForumCount { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadForumData();
    }

    private async Task LoadForumData()
    {
        try
        {
            forums = await Http.GetFromJsonAsync<List<ForumModel>>("api/forums");
            courseGroups = await Http.GetFromJsonAsync<List<CourseGroup>>("api/forums/coursegroups");
            availableCourses = await Http.GetFromJsonAsync<List<CourseModel>>("api/courses");
            SelectGroup("general");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error loading forum data: {ex.Message}", "error");
        }
    }

    private async void ToggleForumExpansion(MouseEventArgs e, int forumId)
    {
        if (expandedForums.Contains(forumId))
        {
            expandedForums.Remove(forumId);
        }
        else
        {
            expandedForums.Add(forumId);
            await LoadTopicsForForum(forumId);
        }
    }

    private async Task LoadTopicsForForum(int forumId)
    {
        try
        {
            selectedForumTopics = await Http.GetFromJsonAsync<List<ForumTopicModel>>($"api/forums/{forumId}/topics");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error loading topics: {ex.Message}", "error");
        }
    }

    private void SelectGroup(string groupName)
    {
        selectedGroup = groupName;
        selectedForumId = null;
        selectedForum = null;
        selectedTopicId = null;
        selectedTopic = null;

        if (groupName == "general")
        {
            selectedGroupForums = forums?.Where(f => f.IsGeneral).ToList();
        }
        else
        {
            selectedGroupForums = forums?.Where(f => f.CourseName == groupName).ToList();
        }
    }

    private async void SelectForum(int forumId)
    {
        selectedForumId = forumId;
        selectedForum = forums?.FirstOrDefault(f => f.Id == forumId);
        selectedTopicId = null;
        selectedTopic = null;

        if (selectedForum != null)
        {
            await LoadTopicsForForum(forumId);
        }
    }

    private async void SelectTopic(int topicId)
    {
        selectedTopicId = topicId;

        if (selectedForumTopics != null)
        {
            selectedTopic = selectedForumTopics.FirstOrDefault(t => t.Id == topicId);
        }
        else
        {
            selectedTopic = null;
        }

        if (selectedTopic != null)
        {
            if (selectedForumId != selectedTopic.ForumId)
            {
                selectedForumId = selectedTopic.ForumId;
                selectedForum = forums?.FirstOrDefault(f => f.Id == selectedTopic.ForumId);
                await LoadTopicsForForum(selectedTopic.ForumId);
            }

            await LoadPostsForTopic(topicId);
        }
    }

    private async Task LoadPostsForTopic(int topicId)
    {
        try
        {
            selectedTopicPosts = await Http.GetFromJsonAsync<List<ForumPostModel>>($"api/forums/topics/{topicId}/posts");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error loading posts: {ex.Message}", "error");
        }
    }

    private void BackToForum()
    {
        selectedTopicId = null;
        selectedTopic = null;
        selectedTopicPosts = null;
    }

    private async void ShowNewTopicModal(MouseEventArgs e, int forumId)
    {
        newTopic = new CreateForumTopicRequest { ForumId = forumId };
        if (newTopicModal != null)
            await newTopicModal.ShowAsync();
    }

    private async void HideNewTopicModal()
    {
        if (newTopicModal != null)
            await newTopicModal.HideAsync();
        newTopic = new CreateForumTopicRequest();
    }

    private async void ShowNewPostModal()
    {
        if (selectedTopicId.HasValue)
        {
            newPost = new CreateForumPostRequest { TopicId = selectedTopicId.Value };
            if (newPostModal != null)
                await newPostModal.ShowAsync();
        }
    }

    private async void HideNewPostModal()
    {
        if (newPostModal != null)
            await newPostModal.HideAsync();
        newPost = new CreateForumPostRequest();
    }

    private void QuotePost(ForumPostModel post)
    {
        quotedText = post.Content;
        quotedAuthor = post.AuthorName;
    }

    private void ClearQuote()
    {
        quotedText = "";
        quotedAuthor = "";
    }

    private async Task EditPost(ForumPostModel post)
    {
        await JSRuntime.InvokeVoidAsync("showToast", "Edit functionality not implemented yet", "info");
    }

    private async Task DeletePost(ForumPostModel post)
    {
        await JSRuntime.InvokeVoidAsync("showToast", "Delete functionality not implemented yet", "info");
    }

    private async Task SendTopicReply()
    {
        if (string.IsNullOrWhiteSpace(newTopicReply) || !selectedTopicId.HasValue) return;

        try
        {
            await Task.Delay(500);

            var reply = new ForumPostModel
            {
                Id = (selectedTopicPosts?.Count ?? 0) + 1,
                TopicId = selectedTopicId.Value,
                Content = !string.IsNullOrEmpty(quotedText) ? $"[Quote from {quotedAuthor}]: {quotedText}\n\n{newTopicReply}" :
            newTopicReply,
                AuthorId = currentUserId ?? "",
                AuthorName = "Current User",
                CreatedAt = DateTime.Now
            };

            selectedTopicPosts?.Add(reply);
            newTopicReply = "";
            ClearQuote();

            await JSRuntime.InvokeVoidAsync("scrollToBottom", "messagesArea");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error sending reply: {ex.Message}", "error");
        }
    }

    private async Task HandleTopicReplyKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendTopicReply();
        }
    }

    private async Task CreateTopic()
    {
        if (currentUserId == null) return;

        try
        {
            isCreatingTopic = true;

            var response = await Http.PostAsJsonAsync("api/forums/topics", newTopic);
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("showToast", "Topic created successfully!", "success");
                HideNewTopicModal();
                if (newTopic.ForumId > 0)
                {
                    await LoadTopicsForForum(newTopic.ForumId);
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("showToast", $"Error creating topic: {error}", "error");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error creating topic: {ex.Message}", "error");
        }
        finally
        {
            isCreatingTopic = false;
        }
    }

    private async Task CreatePost()
    {
        if (currentUserId == null) return;

        try
        {
            isCreatingPost = true;

            var response = await Http.PostAsJsonAsync("api/forums/posts", newPost);
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("showToast", "Post created successfully!", "success");
                HideNewPostModal();
                if (newPost.TopicId > 0)
                {
                    await LoadPostsForTopic(newPost.TopicId);
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("showToast", $"Error creating post: {error}", "error");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error creating post: {ex.Message}", "error");
        }
        finally
        {
            isCreatingPost = false;
        }
    }

    private async Task ShowCreateForumModal()
    {
        if (createForumModal != null)
            await createForumModal.ShowAsync();
    }

    private async Task HideCreateModal()
    {
        if (createForumModal != null)
            await createForumModal.HideAsync();
        newForum = new CreateForumRequest();
    }

    private async Task CreateForum()
    {
        if (currentUserId == null) return;

        try
        {
            isCreating = true;
            await Task.Delay(1000);

            var newForumModel = new ForumModel
            {
                Id = forums?.Count + 1 ?? 1,
                Title = newForum.Title,
                Description = newForum.Description,
                CourseId = newForum.CourseId,
                CourseName = newForum.CourseId.HasValue ? availableCourses?.FirstOrDefault(c => c.Id == newForum.CourseId)?.Title :
            null,
                IsGeneral = !newForum.CourseId.HasValue,
                IsActive = true,
                CreatedAt = DateTime.Now,
                TopicCount = 0,
                LastPostAt = null
            };

            forums?.Add(newForumModel);
            await JSRuntime.InvokeVoidAsync("showToast", "Forum created successfully!", "success");
            HideCreateModal();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error creating forum: {ex.Message}", "error");
        }
        finally
        {
            isCreating = false;
        }
    }
}

<script>
    window.scrollToBottom = (elementId) => {
        const element = document.getElementById(elementId);
        if (element) {
            element.scrollTop = element.scrollHeight;
        }
    };
</script>