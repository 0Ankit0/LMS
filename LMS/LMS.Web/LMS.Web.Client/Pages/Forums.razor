@using BlazorBootstrap;
@page "/user/lms/forums"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Identity
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using System.Net.Http.Json
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<PageTitle>Forums - LMS</PageTitle>

<div class="forums-layout">
    <!-- Course Group Sidebar -->
    <div class="course-group-sidebar">
        <div class="group-list">
            <!-- General Group -->
            <div class="group-item @(selectedGroup == "general" ? "active" : "")"
                @onclick='() => SelectGroup("general")' title="General Discussion">
                <div class="group-icon general-icon">
                    <i class="bi bi-globe"></i>
                </div>
            </div>

            <!-- Course Groups -->
            @if (courseGroups != null)
            {
                @foreach (var courseGroup in courseGroups)
                {
                    <div class="group-item @(selectedGroup == courseGroup.CourseName ? "active" : "")"
                        @onclick="() => SelectGroup(courseGroup.CourseName)" title="@courseGroup.CourseName">
                        <div class="group-icon course-icon">
                            <span class="course-initial">@courseGroup.CourseName.FirstOrDefault()</span>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Add Forum Button -->
        <div class="group-item add-forum-button" @onclick="ShowCreateForumModal" title="Create New Forum">
            <div class="group-icon">
                <i class="bi bi-plus-lg"></i>
            </div>
        </div>
    </div>

    <!-- Forum List Sidebar -->
    <div class="forum-list-sidebar">
        @if (!string.IsNullOrEmpty(selectedGroup))
        {
            <div class="forum-header">
                <h4 class="forum-title">
                    @if (selectedGroup == "general")
                    {
                        <i class="bi bi-globe me-2"></i>
                        <span>General Discussion</span>
                    }
                    else
                    {
                        <i class="bi bi-mortarboard me-2"></i>
                        <span>@selectedGroup</span>
                    }
                </h4>
                <!-- Search Box -->
                <div class="forum-search-container">
                    <input type="text" class="forum-search-input" placeholder="Search forums & topics..."
                        @bind="searchQuery" />
                    <i class="bi bi-search search-icon"></i>
                </div>
            </div>

            <div class="forum-list">
                @if (selectedGroupForums != null)
                {
                    @foreach (var forum in selectedGroupForums)
                    {
                        <div class="forum-accordion">
                            <div class="forum-item @(selectedForumId == forum.Id ? "active" : "")"
                                @onclick="() => SelectForum(forum.Id)">
                                <div class="forum-info">
                                    <div class="forum-name">
                                        <i class="bi bi-hash me-2"></i>
                                        <span>@forum.Title</span>
                                    </div>
                                    <div class="forum-stats">
                                        <small class="text-muted">@forum.TopicCount topics</small>
                                    </div>
                                </div>
                                <div class="forum-actions">
                                    <Button Color="ButtonColor.Secondary" Size="ButtonSize.Small"
                                        @onclick="@(e => ShowNewTopicModal(e, forum.Id))" title="Add new topic">
                                        <i class="bi bi-plus-lg"></i>
                                    </Button>
                                    <Button Color="ButtonColor.Secondary" Size="ButtonSize.Small"
                                        @onclick="@(e => ToggleForumExpansion(e, forum.Id))">
                                        <i
                                            class="bi @(expandedForums.Contains(forum.Id) ? "bi-chevron-up" : "bi-chevron-down")"></i>
                                    </Button>
                                </div>
                            </div>

                            @if (expandedForums.Contains(forum.Id) && selectedForumTopics != null)
                            {
                                <div class="topics-dropdown">
                                    @foreach (var topic in selectedForumTopics.Where(t => t.ForumId == forum.Id))
                                    {
                                        <div class="topic-dropdown-item @(selectedTopicId == topic.Id ? "active" : "")"
                                            @onclick="() => SelectTopic(topic.Id)">
                                            <div class="topic-info">
                                                <div class="topic-icon">
                                                    @if (topic.IsLocked)
                                                    {
                                                        <i class="bi bi-lock text-secondary"></i>
                                                    }
                                                    else
                                                    {
                                                        <i class="bi bi-chat-dots text-primary"></i>
                                                    }
                                                </div>
                                                <div class="topic-details">
                                                    <div class="topic-title">@topic.Title</div>
                                                    <div class="topic-meta">
                                                        <small class="text-muted">@topic.PostCount posts</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        }
        else
        {
            <div class="forum-placeholder">
                <i class="bi bi-chat-dots fa-3x text-muted mb-3"></i>
                <p class="text-muted">Select a group to view forums</p>
            </div>
        }
    </div>

    <!-- Main Discussion Area -->
    <div class="discussion-area">
        @if (selectedForumId.HasValue && selectedForum is not null)
        {
            @if (selectedTopicId.HasValue && selectedTopic is not null)
            {
                <!-- Topic View Header -->
                <div class="discussion-header">
                    <div class="discussion-title">
                        <button class="btn btn-sm btn-outline-secondary me-2" @onclick="BackToForum" title="Back to Forum">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        @if (selectedTopic?.IsLocked == true)
                        {
                            <i class="bi bi-lock me-2 text-secondary"></i>
                        }
                        else
                        {
                            <i class="bi bi-chat-dots me-2"></i>
                        }
                        <span>@selectedTopic?.Title</span>
                    </div>
                    <div class="discussion-actions">
                        <div class="topic-stats me-3">
                            <small class="text-muted">
                                <i class="bi bi-chat-left me-1"></i>@selectedTopic?.PostCount posts
                                <span class="ms-2"><i class="bi bi-person me-1"></i>by @selectedTopic?.CreatedByUserName</span>
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary me-2" title="Search in Topic">
                            <i class="bi bi-search"></i>
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#"><i class="bi bi-lock me-2"></i>Lock Topic</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-trash me-2"></i>Delete
                                        Topic</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Topic Posts - Scrollable -->
                <div class="content-area" id="messagesArea">
                    @if (selectedTopicPosts != null)
                    {
                        @foreach (var post in selectedTopicPosts)
                        {
                            <div class="content-item topic-post">
                                <div class="user-avatar">
                                    <div class="avatar-circle">
                                        <span>@post.AuthorName?.FirstOrDefault()</span>
                                    </div>
                                </div>
                                <div class="content-body post-content">
                                    <div class="content-header">
                                        <span class="author-name">@(post.AuthorName ?? "Unknown")</span>
                                        <span class="post-time">@post.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                                        @if (post.UpdatedAt.HasValue && post.UpdatedAt != post.CreatedAt)
                                        {
                                            <span class="text-muted small">(edited @post.UpdatedAt.Value.ToString("MMM dd, HH:mm"))</span>
                                        }
                                    </div>
                                    <div class="content-text post-text">
                                        @((MarkupString)post.Content.Replace("\n", "<br />"))
                                    </div>
                                    <div class="post-actions">
                                        <button class="btn btn-sm btn-outline-secondary" title="Like">
                                            <i class="bi bi-heart me-1"></i>0
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => QuotePost(post)" title="Quote">
                                            <i class="bi bi-quote me-1"></i>Quote
                                        </button>
                                        @if (currentUserId == post.AuthorId)
                                        {
                                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => EditPost(post)" title="Edit">
                                                <i class="bi bi-pencil me-1"></i>Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeletePost(post)" title="Delete">
                                                <i class="bi bi-trash me-1"></i>Delete
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>

                <!-- Quick Reply - Sticky Bottom -->
                @if (selectedTopic?.IsLocked != true)
                {
                    <div class="input-area">
                        @if (!string.IsNullOrEmpty(quotedText))
                        {
                            <div class="quoted-text">
                                <div class="quote-header">
                                    <span>Replying to @quotedAuthor:</span>
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="ClearQuote">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                                <div class="quote-content">@quotedText</div>
                            </div>
                        }
                        <div class="input-container">
                            <input type="text" class="message-input" placeholder="Reply to @selectedTopic?.Title..."
                                @bind="newTopicReply" @onkeypress="HandleTopicReplyKeyPress" />
                            <button class="send-button" @onclick="SendTopicReply"
                                disabled="@string.IsNullOrWhiteSpace(newTopicReply)">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </div>
                }
            }
            else
            {
                <!-- Forum Topics View -->
                <div class="discussion-header">
                    <div class="discussion-title">
                        <i class="bi bi-hash me-2"></i>
                        <span>@selectedForum.Title</span>
                    </div>
                    <div class="discussion-actions">
                        <div class="forum-stats me-3">
                            <small class="text-muted">
                                <i class="bi bi-list me-1"></i>@selectedForum.TopicCount topics
                                <span class="ms-2"><i class="bi bi-people me-1"></i>@(selectedForumTopics?.SelectMany(t => new[]
                                                                { t.CreatedByUserId }).Distinct().Count() ?? 0) contributors</span>
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary me-2" title="Search Topics">
                            <i class="bi bi-search"></i>
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                data-bs-toggle="dropdown">
                                <i class="bi bi-sort-down"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#"><i class="bi bi-calendar me-2"></i>Sort by Date</a></li>
                                <li><a class="dropdown-item" href="#"><i class="bi bi-reply me-2"></i>Sort by Replies</a></li>
                                <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Sort by Author</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Topics List -->
                <div class="content-area topics-area" id="topicsArea">
                    @if (selectedForumTopics != null && selectedForumTopics.Any())
                    {
                        @foreach (var topic in selectedForumTopics)
                        {
                            <div class="topic-item" @onclick="() => SelectTopic(topic.Id)">
                                <div class="topic-icon">
                                    @if (topic.IsLocked)
                                    {
                                        <i class="bi bi-lock text-secondary"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-chat-dots text-primary"></i>
                                    }
                                </div>
                                <div class="topic-content">
                                    <div class="topic-header">
                                        <h6 class="topic-title">@topic.Title</h6>
                                        <div class="topic-badges">
                                            @if (topic.IsLocked)
                                            {
                                                <span class="badge bg-secondary">Locked</span>
                                            }
                                        </div>
                                    </div>
                                    <div class="topic-meta">
                                        <span class="topic-author">by <strong>@topic.CreatedByUserName</strong></span>
                                        <span class="topic-date">@topic.CreatedAt.ToString("MMM dd, yyyy")</span>
                                        @if (topic.LastPostAt.HasValue)
                                        {
                                            <span class="topic-last-post">Last: @topic.LastPostAt.Value.ToString("MMM dd, HH:mm")</span>
                                        }
                                    </div>
                                </div>
                                <div class="topic-stats">
                                    <div class="post-count">
                                        <span class="count">@topic.PostCount</span>
                                        <small>posts</small>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="content-placeholder">
                            <i class="bi bi-chat-dots fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">No Topics Yet</h5>
                            <p class="text-muted">Be the first to start a discussion in this forum!</p>
                        </div>
                    }
                </div>
            }


        }
        else
        {
            <div class="chat-placeholder p-4">
                <i class="fas fa-comments fa-5x text-muted mb-4"></i>
                <h3 class="text-muted mb-2 ">Welcome to Forums</h3>
                <p class="text-muted">Select a forum from the sidebar to view topics and discussions</p>
            </div>
        }
    </div>
</div>

<!-- New Topic Modal -->
@if (showNewTopicModal)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle me-2"></i>Create New Topic
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="HideNewTopicModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@newTopic" OnValidSubmit="CreateTopic">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="alert alert-danger" />

                        <div class="mb-3">
                            <label for="topicTitle" class="form-label fw-semibold">
                                <i class="fas fa-heading me-1"></i>Topic Title
                            </label>
                            <InputText id="topicTitle" class="form-control form-control-lg" @bind-Value="newTopic.Title"
                                placeholder="Enter an engaging topic title..." />
                            <ValidationMessage For="@(() => newTopic.Title)" />
                        </div>

                        <div class="mb-3">
                            <label for="topicContent" class="form-label fw-semibold">
                                <i class="bi bi-text-paragraph me-1"></i>Initial Post Content
                            </label>
                            <InputTextArea id="topicContent" class="form-control" rows="8"
                                @bind-Value="newTopic.InitialPost"
                                placeholder="Start the discussion with your thoughts..." />
                            <ValidationMessage For="@(() => newTopic.InitialPost)" />
                            <div class="form-text">You can use basic formatting: **bold**, *italic*, `code`</div>
                        </div>

                        <div class="modal-footer border-0 px-0 mt-3">
                            <button type="button" class="btn btn-light" @onclick="HideNewTopicModal">
                                <i class="bi bi-x-lg me-1"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" disabled="@isCreatingTopic">
                                @if (isCreatingTopic)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Creating...</span>
                                }
                                else
                                {
                                    <i class="bi bi-plus-lg me-1"></i>
                                    <span>Create Topic</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<!-- New Post Modal -->
@if (showNewPostModal)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-reply me-2"></i>Reply to: @selectedTopic?.Title
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="HideNewPostModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@newPost" OnValidSubmit="CreatePost">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="alert alert-danger" />

                        @if (!string.IsNullOrEmpty(quotedText))
                        {
                            <div class="quote-preview mb-3">
                                <div class="quote-header">
                                    <strong>@quotedAuthor wrote:</strong>
                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" @onclick="ClearQuote">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="quote-body">@quotedText</div>
                            </div>
                        }

                        <div class="mb-3">
                            <label for="postContent" class="form-label fw-semibold">
                                <i class="fas fa-align-left me-1"></i>Your Reply
                            </label>
                            <InputTextArea id="postContent" class="form-control" rows="8" @bind-Value="newPost.Content"
                                placeholder="Share your thoughts..." />
                            <ValidationMessage For="@(() => newPost.Content)" />
                            <div class="form-text">You can use basic formatting: **bold**, *italic*, `code`</div>
                        </div>

                        <div class="modal-footer border-0 px-0">
                            <button type="button" class="btn btn-light" @onclick="HideNewPostModal">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" disabled="@isCreatingPost">
                                @if (isCreatingPost)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Posting...</span>
                                }
                                else
                                {
                                    <i class="fas fa-reply me-1"></i>
                                    <span>Post Reply</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<!-- Create Forum Modal -->
<Modal @ref="createForumModal" Title="Create New Forum">
    <BodyTemplate>
        <EditForm Model="@newForum" OnValidSubmit="CreateForum">
            <DataAnnotationsValidator />
            <ValidationSummary class="alert alert-danger" />

            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label for="title" class="form-label fw-semibold">
                            <i class="fas fa-heading me-1"></i>Forum Title
                        </label>
                        <InputText id="title" class="form-control form-control-lg" @bind-Value="newForum.Title"
                            placeholder="Enter forum title..." />
                        <ValidationMessage For="@(() => newForum.Title)" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="courseId" class="form-label fw-semibold">
                            <i class="fas fa-graduation-cap me-1"></i>Course
                        </label>
                        <InputSelect id="courseId" class="form-select" @bind-Value="newForum.CourseId">
                            <option value="">General Forum</option>
                            @if (availableCourses != null)
                            {
                                @foreach (var course in availableCourses)
                                {
                                    <option value="@course.Id">@course.Title</option>
                                }
                            }
                        </InputSelect>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label fw-semibold">
                    <i class="fas fa-align-left me-1"></i>Description
                </label>
                <InputTextArea id="description" class="form-control" rows="4" @bind-Value="newForum.Description"
                    placeholder="Describe what this forum is about..." />
                <ValidationMessage For="@(() => newForum.Description)" />
            </div>

            <div class="modal-footer border-0 px-0">
                <Button Color="ButtonColor.Light" @onclick="HideCreateModal">
                    <i class="fas fa-times me-1"></i>Cancel
                </Button>
                <Button Color="ButtonColor.Primary" Type="ButtonType.Submit" IsLoading="@isCreating">
                    <i class="fas fa-plus me-1"></i>
                    <span>Create Forum</span>
                </Button>
            </div>
        </EditForm>
    </BodyTemplate>
</Modal>

@code {
    // Removed unused fields: isLoading, showCreateModal, forumMessages
    private bool isCreating = false;
    private Modal? createForumModal;
    private string? currentUserId = "current-user"; // Set a dummy user for demo
    private string newMessage = "";
    private string newTopicReply = "";
    private string searchQuery = "";

    // Enhanced forum features
    private bool showNewTopicModal = false;
    private bool showNewPostModal = false;
    private bool isCreatingTopic = false;
    private bool isCreatingPost = false;

    // Topic and post management
    private int? selectedTopicId;
    private ForumTopicModel? selectedTopic;
    private List<ForumTopicModel>? selectedForumTopics;
    private List<ForumPostModel>? selectedTopicPosts;
    private string quotedText = "";
    private string quotedAuthor = "";

    // Discord-like state management
    private string selectedGroup = "";
    private int? selectedForumId;
    private ForumModel? selectedForum;
    private List<ForumModel>? selectedGroupForums;
    private List<CourseGroup>? courseGroups;
    private HashSet<int> expandedForums = new HashSet<int>();

    private List<ForumModel>? forums;
    private List<CourseModel>? availableCourses;
    private CreateForumRequest newForum = new();
    private CreateForumTopicRequest newTopic = new();
    private CreateForumPostRequest newPost = new();

    public class CourseGroup
    {
        public string CourseName { get; set; } = "";
        public int ForumCount { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadForumData();
    }

    private async Task LoadForumData()
    {
        try
        {
            forums = await Http.GetFromJsonAsync<List<ForumModel>>("api/forums");
            courseGroups = await Http.GetFromJsonAsync<List<CourseGroup>>("api/forums/coursegroups");
            availableCourses = await Http.GetFromJsonAsync<List<CourseModel>>("api/courses");
            SelectGroup("general");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error loading forum data: {ex.Message}", "error");
        }
    }

    private async void ToggleForumExpansion(MouseEventArgs e, int forumId)
    {
        if (expandedForums.Contains(forumId))
        {
            expandedForums.Remove(forumId);
        }
        else
        {
            expandedForums.Add(forumId);
            await LoadTopicsForForum(forumId);
        }
    }

    private async Task LoadTopicsForForum(int forumId)
    {
        try
        {
            selectedForumTopics = await Http.GetFromJsonAsync<List<ForumTopicModel>>($"api/forums/{forumId}/topics");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error loading topics: {ex.Message}", "error");
        }
    }

    private void SelectGroup(string groupName)
    {
        selectedGroup = groupName;
        selectedForumId = null;
        selectedForum = null;
        selectedTopicId = null;
        selectedTopic = null;

        if (groupName == "general")
        {
            selectedGroupForums = forums?.Where(f => f.IsGeneral).ToList();
        }
        else
        {
            selectedGroupForums = forums?.Where(f => f.CourseName == groupName).ToList();
        }
    }

    private async void SelectForum(int forumId)
    {
        selectedForumId = forumId;
        selectedForum = forums?.FirstOrDefault(f => f.Id == forumId);
        selectedTopicId = null;
        selectedTopic = null;

        if (selectedForum != null)
        {
            await LoadTopicsForForum(forumId);
        }
    }

    private async void SelectTopic(int topicId)
    {
        selectedTopicId = topicId;

        if (selectedForumTopics != null)
        {
            selectedTopic = selectedForumTopics.FirstOrDefault(t => t.Id == topicId);
        }
        else
        {
            selectedTopic = null;
        }

        if (selectedTopic != null)
        {
            if (selectedForumId != selectedTopic.ForumId)
            {
                selectedForumId = selectedTopic.ForumId;
                selectedForum = forums?.FirstOrDefault(f => f.Id == selectedTopic.ForumId);
                await LoadTopicsForForum(selectedTopic.ForumId);
            }

            await LoadPostsForTopic(topicId);
        }
    }

    private async Task LoadPostsForTopic(int topicId)
    {
        try
        {
            selectedTopicPosts = await Http.GetFromJsonAsync<List<ForumPostModel>>($"api/forums/topics/{topicId}/posts");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error loading posts: {ex.Message}", "error");
        }
    }

    private void BackToForum()
    {
        selectedTopicId = null;
        selectedTopic = null;
        selectedTopicPosts = null;
    }

    private void ShowNewTopicModal()
    {
        if (selectedForumId.HasValue)
        {
            newTopic = new CreateForumTopicRequest { ForumId = selectedForumId.Value };
            showNewTopicModal = true;
        }
    }

    private void ShowNewTopicModal(MouseEventArgs e, int forumId)
    {
        newTopic = new CreateForumTopicRequest { ForumId = forumId };
        showNewTopicModal = true;
    }

    private void HideNewTopicModal()
    {
        showNewTopicModal = false;
        newTopic = new CreateForumTopicRequest();
    }

    private void ShowNewPostModal()
    {
        if (selectedTopicId.HasValue)
        {
            newPost = new CreateForumPostRequest { TopicId = selectedTopicId.Value };
            showNewPostModal = true;
        }
    }

    private void HideNewPostModal()
    {
        showNewPostModal = false;
        newPost = new CreateForumPostRequest();
    }

    private void QuotePost(ForumPostModel post)
    {
        quotedText = post.Content;
        quotedAuthor = post.AuthorName;
    }

    private void ClearQuote()
    {
        quotedText = "";
        quotedAuthor = "";
    }

    private async Task EditPost(ForumPostModel post)
    {
        await JSRuntime.InvokeVoidAsync("showToast", "Edit functionality not implemented yet", "info");
    }

    private async Task DeletePost(ForumPostModel post)
    {
        await JSRuntime.InvokeVoidAsync("showToast", "Delete functionality not implemented yet", "info");
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage) || !selectedForumId.HasValue) return;

        try
        {
            await Task.Delay(500);
            newMessage = "";
            await JSRuntime.InvokeVoidAsync("scrollToBottom", "messagesArea");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error sending message: {ex.Message}", "error");
        }
    }

    private async Task SendTopicReply()
    {
        if (string.IsNullOrWhiteSpace(newTopicReply) || !selectedTopicId.HasValue) return;

        try
        {
            await Task.Delay(500);

            var reply = new ForumPostModel
            {
                Id = (selectedTopicPosts?.Count ?? 0) + 1,
                TopicId = selectedTopicId.Value,
                Content = !string.IsNullOrEmpty(quotedText) ? $"[Quote from {quotedAuthor}]: {quotedText}\n\n{newTopicReply}" :
            newTopicReply,
                AuthorId = currentUserId ?? "",
                AuthorName = "Current User",
                CreatedAt = DateTime.Now
            };

            selectedTopicPosts?.Add(reply);
            newTopicReply = "";
            ClearQuote();

            await JSRuntime.InvokeVoidAsync("scrollToBottom", "messagesArea");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error sending reply: {ex.Message}", "error");
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }

    private async Task HandleTopicReplyKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendTopicReply();
        }
    }

    private async Task CreateTopic()
    {
        if (currentUserId == null) return;

        try
        {
            isCreatingTopic = true;

            var response = await Http.PostAsJsonAsync("api/forums/topics", newTopic);
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("showToast", "Topic created successfully!", "success");
                HideNewTopicModal();
                if (newTopic.ForumId > 0)
                {
                    await LoadTopicsForForum(newTopic.ForumId);
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("showToast", $"Error creating topic: {error}", "error");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error creating topic: {ex.Message}", "error");
        }
        finally
        {
            isCreatingTopic = false;
        }
    }

    private async Task CreatePost()
    {
        if (currentUserId == null) return;

        try
        {
            isCreatingPost = true;

            var response = await Http.PostAsJsonAsync("api/forums/posts", newPost);
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("showToast", "Post created successfully!", "success");
                HideNewPostModal();
                if (newPost.TopicId > 0)
                {
                    await LoadPostsForTopic(newPost.TopicId);
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("showToast", $"Error creating post: {error}", "error");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error creating post: {ex.Message}", "error");
        }
        finally
        {
            isCreatingPost = false;
        }
    }

    private async Task ShowCreateForumModal()
    {
        await createForumModal?.ShowAsync()!;
    }

    private async Task HideCreateModal()
    {
        await createForumModal?.HideAsync()!;
        newForum = new CreateForumRequest();
    }

    private async Task CreateForum()
    {
        if (currentUserId == null) return;

        try
        {
            isCreating = true;
            await Task.Delay(1000);

            var newForumModel = new ForumModel
            {
                Id = forums?.Count + 1 ?? 1,
                Title = newForum.Title,
                Description = newForum.Description,
                CourseId = newForum.CourseId,
                CourseName = newForum.CourseId.HasValue ? availableCourses?.FirstOrDefault(c => c.Id == newForum.CourseId)?.Title :
            null,
                IsGeneral = !newForum.CourseId.HasValue,
                IsActive = true,
                CreatedAt = DateTime.Now,
                TopicCount = 0,
                LastPostAt = null
            };

            forums?.Add(newForumModel);
            await JSRuntime.InvokeVoidAsync("showToast", "Forum created successfully!", "success");
            HideCreateModal();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("showToast", $"Error creating forum: {ex.Message}", "error");
        }
        finally
        {
            isCreating = false;
        }
    }
}

<script>
    window.scrollToBottom = (elementId) => {
        const element = document.getElementById(elementId);
        if (element) {
            element.scrollTop = element.scrollHeight;
        }
    };
</script>