@using LMS.Data.DTOs
@using MudBlazor
@inject IDialogService DialogService

<MudCard Elevation="2"
    Class="mb-4 rounded-2xl shadow-lg bg-white dark:bg-gray-900 hover:shadow-xl transition-shadow duration-200 cursor-pointer"
    @onclick="ShowDialog">
    <MudCardHeader
        Class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 p-4 border-b border-gray-100 dark:border-gray-800">
        <CardHeaderContent>
            <MudText Typo="Typo.h6" Class="font-bold text-indigo-700 dark:text-indigo-300">@Announcement.Title</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudChip T="string" Icon="@GetPriorityIcon(Announcement.Priority)"
                Color="@GetPriorityBadgeColor(Announcement.Priority)" Class="w-fit">@Announcement.Priority Priority
            </MudChip>
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent Class="p-4">
        <MudText Typo="Typo.body2" Class="text-gray-600 dark:text-gray-300">@GetExcerpt(Announcement.Content)</MudText>
    </MudCardContent>
    <MudCardActions Class="flex flex-wrap gap-2 p-4 border-t border-gray-100 dark:border-gray-800 items-center">
        <MudText Typo="Typo.caption" Class="text-gray-400 flex items-center">
            <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-1" />
            @Announcement.AuthorName
        </MudText>
        <MudText Typo="Typo.caption" Class="text-gray-400 flex items-center">
            <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Class="mr-1" />
            @FormatDate(Announcement.PublishedAt)
        </MudText>
        <MudSpacer />
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" @onclick="ShowDialog"
            StartIcon="@Icons.Material.Filled.Visibility">View</MudButton>
    </MudCardActions>
</MudCard>

@code {
    [Parameter]
    public AnnouncementModel Announcement { get; set; } = new();

    private void ShowDialog()
    {
        var parameters = new DialogParameters { ["Announcement"] = Announcement };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        DialogService.ShowAsync<AnnouncementDialog>("Announcement Details", parameters, options);
    }

    private string GetPriorityIcon(string priority)
    {
        return priority.ToLower() switch
        {
            "high" => Icons.Material.Filled.Warning,
            "medium" => Icons.Material.Filled.Info,
            "low" => Icons.Material.Filled.Notifications,
            _ => Icons.Material.Filled.Info
        };
    }

    private MudBlazor.Color GetPriorityBadgeColor(string? priority)
    {
        return (priority ?? "").ToLower() switch
        {
            "high" => MudBlazor.Color.Error,
            "medium" => MudBlazor.Color.Warning,
            "low" => MudBlazor.Color.Info,
            _ => MudBlazor.Color.Secondary
        };
    }

    private string FormatDate(DateTime date)
    {
        var timeSpan = DateTime.Now - date;
        if (timeSpan.Days > 0)
        {
            return $"{timeSpan.Days} day{(timeSpan.Days > 1 ? "s" : "")} ago";
        }
        else if (timeSpan.Hours > 0)
        {
            return $"{timeSpan.Hours} hour{(timeSpan.Hours > 1 ? "s" : "")} ago";
        }
        else if (timeSpan.Minutes > 0)
        {
            return $"{timeSpan.Minutes} minute{(timeSpan.Minutes > 1 ? "s" : "")} ago";
        }
        else
        {
            return "Just now";
        }
    }

    private string GetExcerpt(string content)
    {
        if (string.IsNullOrEmpty(content))
            return "";
        const int maxLength = 120;
        if (content.Length <= maxLength)
            return content;
        return content.Substring(0, maxLength) + "...";
    }
}



