@using LMS.Web.Components.Account
@using MudBlazor;
@using MudBlazor.Components;
@using System.Security.Claims;
@page "/user/lms/my-courses"
@inject UserManager<User> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IEnrollmentRepository EnrollmentRepository
@inject ISnackbar Snackbar


<PageTitle>My Courses - LMS</PageTitle>

<div class="container-fluid">
    <MudToolBar Class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <MudText Typo="Typo.h5" Class="h2">
            <MudIcon Icon="@Icons.Material.Filled.Book" Class="me-2" />My Courses
        </MudText>
        <MudSpacer />
        <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined">
            <MudButton OnClick='() => FilterCourses("all")' Variant="@(currentFilter == "all" ? Variant.Filled : Variant.Outlined)">All</MudButton>
            <MudButton OnClick='() => FilterCourses("active")' Variant="@(currentFilter == "active" ? Variant.Filled : Variant.Outlined)">Active</MudButton>
            <MudButton OnClick='() => FilterCourses("completed")' Variant="@(currentFilter == "completed" ? Variant.Filled : Variant.Outlined)">Completed</MudButton>
        </MudButtonGroup>
    </MudToolBar>

    @if (isLoading)
    {
        <MudGrid Spacing="3">
            @for (int i = 0; i < 6; i++)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="350px" />
                </MudItem>
            }
        </MudGrid>
    }
    else if (filteredEnrollments?.Any() == true)
    {
        @foreach (var enrollment in filteredEnrollments)
        {
            <MudItem xs="12" md="6" lg="4">
                <MudCard Elevation="2" Class="h-100">
                    <MudCardMedia Image="@enrollment.CourseThumbnailUrl" Style="height: 200px; object-fit: cover;" Alt="@enrollment.CourseTitle" />
                    <MudCardContent>
                        <MudText Typo="Typo.h5">@enrollment.CourseTitle</MudText>
                        <MudText Typo="Typo.body2">@enrollment.CourseDescription</MudText>
                        <MudProgressLinear Value="@enrollment.ProgressPercentage" Color="Color.Success" Class="my-3" />
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <MudText Typo="Typo.caption">Progress</MudText>
                            <MudText Typo="Typo.caption">@($"{enrollment.ProgressPercentage:F0}%")</MudText>
                        </div>
                        <div>
                            @if (enrollment.CompletedAt.HasValue)
                            {
                                <MudChip T="string" Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small">Completed</MudChip>
                            }
                            else if (enrollment.LastAccessedAt.HasValue && enrollment.LastAccessedAt > DateTime.Now.AddDays(-7))
                            {
                                <MudChip T="string" Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Primary" Size="Size.Small">Active</MudChip>
                            }
                            else
                            {
                                <MudChip T="string" Icon="@Icons.Material.Filled.Pause" Color="Color.Warning" Size="Size.Small">Paused</MudChip>
                            }
                        </div>
                        <div class="mt-3">
                            <MudText Typo="Typo.caption" Class="d-block">
                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="me-1" />
                                Enrolled: @enrollment.EnrolledAt.ToString("MMM dd, yyyy")
                            </MudText>
                            @if (enrollment.LastAccessedAt.HasValue)
                            {
                                <MudText Typo="Typo.caption" Class="d-block">
                                    <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Class="me-1" />
                                    Last accessed: @enrollment.LastAccessedAt.Value.ToString("MMM dd, yyyy")
                                </MudText>
                            }
                        </div>
                    </MudCardContent>
                    <MudCardActions>
                        @if (IsAdmin)
                        {
                            <MudButton Color="Color.Info" Size="Size.Small" Href="@($"/admin/courses/manage/{enrollment.CourseId}")" StartIcon="@Icons.Material.Filled.Settings">Manage</MudButton>
                        }
                        @if (enrollment.CompletedAt.HasValue)
                        {
                            <MudButton Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Small" Href="@($"/course/{enrollment.CourseId}")" StartIcon="@Icons.Material.Filled.Visibility">Review</MudButton>
                            <MudButton Color="Color.Success" Size="Size.Small" OnClick="() => DownloadCertificate(enrollment.CourseId)" StartIcon="@Icons.Material.Filled.Download">Certificate</MudButton>
                        }
                        else
                        {
                            <MudButton Color="Color.Primary" Size="Size.Small" Href="@($"/course/{enrollment.CourseId}")" StartIcon="@Icons.Material.Filled.PlayArrow">Continue</MudButton>
                            <MudButton Color="Color.Error" Variant="Variant.Outlined" Size="Size.Small" OnClick="() => ShowUnenrollModal(enrollment)" StartIcon="@Icons.Material.Filled.Close">Unenroll</MudButton>
                        }
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    }
    else
    {
        <MudItem xs="12">
            <div classs="text-center py-5">
                <MudIcon Icon="@Icons.Material.Filled.Book" Size="Size.Large" Class="text-muted mb-3" />
                <MudText Typo="Typo.h5" Class="text-muted">No courses found</MudText>
                <MudText Typo="Typo.body1" Class="text-muted">@GetEmptyStateMessage()</MudText>
                <MudButton Color="Color.Primary" Href="/courses" StartIcon="@Icons.Material.Filled.Search">Browse Courses</MudButton>
            </div>
        </MudItem>
    }
</div>



<!-- Unenroll Confirmation Modal -->
<MudDialog @bind-IsVisible="@isUnenrollModalVisible" Options="@dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Confirm Unenrollment</MudText>
    </TitleContent>
    <DialogContent>
        @if (selectedEnrollment != null)
        {
            <MudText>Are you sure you want to unenroll from <strong>@selectedEnrollment.CourseTitle</strong>?</MudText>
            <MudAlert Severity="Severity.Warning" Class="mt-3">
                <MudIcon Icon="@Icons.Material.Filled.Warning" Class="me-2" />
                Your progress will be lost and cannot be recovered.
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Secondary" OnClick="HideUnenrollModal">Cancel</MudButton>
        <MudButton Color="Color.Error" OnClick="ConfirmUnenroll">
            Unenroll
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool isLoading = true;
    private string currentFilter = "all";
    private string? currentUserId;

    private List<LMS.Data.DTOs.EnrollmentModel>? enrollments;
    private List<LMS.Data.DTOs.EnrollmentModel>? filteredEnrollments;
    private LMS.Data.DTOs.EnrollmentModel? selectedEnrollment;
    private bool isUnenrollModalVisible = false;
    private DialogOptions dialogOptions = new() { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
    private bool IsAdmin = false; // Placeholder for admin role check

    protected override async Task OnInitializedAsync()
    {
        await LoadUserCourses();
    }

    private async Task LoadUserCourses()
    {
        try
        {
            isLoading = true;
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = await UserManager.GetUserAsync(authState.User);
            if (user is not null)
            {
                currentUserId = user.Id;
                IsAdmin = await UserManager.IsInRoleAsync(user, "Admin");

                if (!string.IsNullOrEmpty(currentUserId))
                {
                    enrollments = await EnrollmentRepository.GetUserEnrollmentsAsync(currentUserId);
                    FilterCourses(currentFilter);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading courses: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FilterCourses(string filter)
    {
        currentFilter = filter;
        if (enrollments == null) return;

        filteredEnrollments = filter switch
        {
            "active" => enrollments.Where(e => !e.CompletedAt.HasValue).ToList(),
            "completed" => enrollments.Where(e => e.CompletedAt.HasValue).ToList(),
            _ => enrollments.ToList()
        };
    }

    private string GetEmptyStateMessage()
    {
        return currentFilter switch
        {
            "active" => "You don't have any active courses.",
            "completed" => "You haven't completed any courses yet.",
            _ => "You haven't enrolled in any courses yet."
        };
    }

    private void ShowUnenrollModal(LMS.Data.DTOs.EnrollmentModel enrollment)
    {
        selectedEnrollment = enrollment;
        isUnenrollModalVisible = true;
    }

    private void HideUnenrollModal()
    {
        isUnenrollModalVisible = false;
        selectedEnrollment = null;
    }

    private async Task ConfirmUnenroll()
    {
        if (selectedEnrollment == null || currentUserId == null) return;

        try
        {
            var success = await EnrollmentRepository.UnenrollUserAsync(currentUserId, selectedEnrollment.CourseId);
            if (success)
            {
                Snackbar.Add("Successfully unenrolled from course", Severity.Success);
                await LoadUserCourses();
                HideUnenrollModal();
            }
            else
            {
                Snackbar.Add("Failed to unenroll from course", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void DownloadCertificate(int courseId)
    {
        Snackbar.Add("Certificate download functionality will be implemented soon", Severity.Info);
    }
}