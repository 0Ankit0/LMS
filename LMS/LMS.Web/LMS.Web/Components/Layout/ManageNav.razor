@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@inject SignInManager<User> SignInManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject HttpClient Http
@rendermode InteractiveAuto

<MudAppBar Elevation="0">
    <MudText Typo="Typo.h6" Class="mud-text-primary" Href="/home" Style="font-size:1.3rem; letter-spacing:1px;">LMS</MudText>
    <MudSpacer />
    @if (isAuthenticated)
    {
        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
            <ActivatorContent>
                <MudButton Variant="Variant.Text" Color="Color.Inherit" EndIcon="@Icons.Material.Filled.ArrowDropDown">Account</MudButton>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem OnClick="@(() => NavigationManager.NavigateTo("/Account/manage"))">Manage</MudMenuItem>
                <MudMenuItem OnClick="@(() => NavigationManager.NavigateTo("/Account/changepassword"))">Change Password</MudMenuItem>
                <MudMenuItem OnClick="@(() => NavigationManager.NavigateTo("/Account/externallogins"))">External Logins</MudMenuItem>
                <MudMenuItem OnClick="@(() => NavigationManager.NavigateTo("/Account/personaldata"))">Personal Data</MudMenuItem>
                <MudDivider />
                <MudMenuItem OnClick="LogoutAsync">Logout</MudMenuItem>
            </ChildContent>
        </MudMenu>
    }
    else
    {
        <MudButton Href="/Account/Login" Variant="Variant.Text" Color="Color.Inherit">Login</MudButton>
    }
</MudAppBar>

@code {
    private bool isAuthenticated;
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;
    }
    private async Task LogoutAsync()
    {
        await SignInManager.SignOutAsync();
        isAuthenticated = false;
        NavigationManager.NavigateTo("/Account/Login");
    }
}
