@page "/admin/courses/manage"
@rendermode @(new InteractiveServerRenderMode())
@using LMS.Repositories
@using LMS.Web.Components.Shared
@using LMS.Web.Services
@inject ICourseRepository CourseRepository
@inject IModuleRepository ModuleRepository
@inject ILessonRepository LessonRepository
@inject NavigationManager NavigationManager
@inject LMS.Web.Services.ToastService ToastService

<PageTitle>Manage Course - Admin</PageTitle>

@if (course != null)
{
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Manage Course: @course.Title</h1>
        <Button Color="ButtonColor.Secondary" Href="/admin/courses">
            <Icon Name="IconName.ArrowLeft" />
            Back to Courses
        </Button>
    </div>

    <div class="row">
        <div class="col-md-4">
            <Card>
                <CardHeader>
                    <h5 class="mb-0">Add New Module</h5>
                </CardHeader>
                <CardBody>
                    <EditForm Model="newModule" OnValidSubmit="AddModule">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <InputText @bind-Value="newModule.Title" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <InputTextArea @bind-Value="newModule.Description" class="form-control" />
                        </div>

                        <Button Color="ButtonColor.Primary" Type="ButtonType.Submit">Add Module</Button>
                    </EditForm>
                </CardBody>
            </Card>
        </div>
        <div class="col-md-8">
            <Card>
                <CardHeader>
                    <h5 class="mb-0">Modules</h5>
                </CardHeader>
                <CardBody>
                    @if (course.Modules.Any())
                    {
                        <Accordion>
                            @foreach (var module in course.Modules)
                            {
                                <AccordionItem>
                                    <Title>@module.Title</Title>
                                    <Body>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">Lessons</h6>
                                            <Button Color="ButtonColor.Primary" Size="ButtonSize.Small" @onclick="() => ShowAddLessonModal(module.Id)">
                                                <Icon Name="IconName.Plus" /> Add Lesson
                                            </Button>
                                        </div>
                                        <ul class="list-group">
                                            @foreach (var lesson in module.Lessons)
                                            {
                                                <li class="list-group-item">@lesson.Title</li>
                                            }
                                        </ul>
                                    </Body>
                                </AccordionItem>
                            }
                        </Accordion>
                    }
                    else
                    {
                        <p>No modules have been added to this course yet.</p>
                    }
                </CardBody>
            </Card>
        </div>
    </div>
}
else
{
    <p><em>Loading...</em></p>
}

<Modal @ref="addLessonModal" Title="Add New Lesson">
    <BodyTemplate>
        <EditForm Model="newLesson" OnValidSubmit="AddLesson">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-3">
                <label class="form-label">Title</label>
                <InputText @bind-Value="newLesson.Title" class="form-control" />
            </div>

            <div class="mb-3">
                <label class="form-label">Description</label>
                <InputTextArea @bind-Value="newLesson.Description" class="form-control" />
            </div>

            <Button Color="ButtonColor.Primary" Type="ButtonType.Submit">Add Lesson</Button>
        </EditForm>
    </BodyTemplate>
</Modal>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public int Id { get; set; }

    private CourseModel course;
    private CreateModuleRequest newModule = new();
    private CreateLessonRequest newLesson = new();
    private Modal addLessonModal;
    private int selectedModuleId;

    protected override async Task OnInitializedAsync()
    {
        // Try to get course from server
        course = await CourseRepository.GetCourseByIdAsync(Id);

        if (course == null)
        {
            course = AddDummyCourses().FirstOrDefault(c => c.Id == Id) ?? AddDummyCourses().First();
        }
        else if (course.Modules == null || !course.Modules.Any())
        {
            course.Modules = AddDummyModules(course.Id);
        }
        else
        {
            foreach (var module in course.Modules)
            {
                if (module.Lessons == null || !module.Lessons.Any())
                {
                    module.Lessons = AddDummyLessons(module.Id);
                }
            }
        }
    }

    private async Task AddModule()
    {
        newModule.CourseId = Id;
        var result = await ModuleRepository.CreateModuleAsync(newModule);
        if (result != null)
        {
            course = await CourseRepository.GetCourseByIdAsync(Id)
                     ?? AddDummyCourses().FirstOrDefault(c => c.Id == Id) ?? AddDummyCourses().First();
            newModule = new();
            ToastService.ShowSuccess("Success", "Module created successfully!");
        }
        else
        {
            ToastService.ShowError("Error", "Failed to create module. Please try again.");
        }
    }

    private void ShowAddLessonModal(int moduleId)
    {
        selectedModuleId = moduleId;
        addLessonModal.ShowAsync();
    }

    private async Task AddLesson()
    {
        newLesson.ModuleId = selectedModuleId;
        var result = await LessonRepository.CreateLessonAsync(newLesson);
        if (result != null)
        {
            course = await CourseRepository.GetCourseByIdAsync(Id)
                     ?? AddDummyCourses().FirstOrDefault(c => c.Id == Id) ?? AddDummyCourses().First();
            newLesson = new();
            addLessonModal.HideAsync();
            ToastService.ShowSuccess("Success", "Lesson created successfully!");
        }
        else
        {
            ToastService.ShowError("Error", "Failed to create lesson. Please try again.");
        }
    }

    // Dummy data helpers
    private List<CourseModel> AddDummyCourses()
    {
        return new List<CourseModel>
        {
            new CourseModel
            {
                Id = 1,
                Title = "Introduction to Programming",
                Description = "Learn the basics of programming",
                Level = "Beginner",
                Status = "Published",
                MaxEnrollments = 100,
                StartDate = DateTime.Now.AddDays(7),
                EndDate = DateTime.Now.AddDays(67),
                InstructorId = "instructor-1",
                InstructorName = "John Doe",
                EstimatedDuration = TimeSpan.FromHours(40),
                Modules = AddDummyModules(1)
            },
            new CourseModel
            {
                Id = 2,
                Title = "Modern Web Development",
                Description = "Master modern web development techniques",
                Level = "Advanced",
                Status = "Published",
                MaxEnrollments = 50,
                StartDate = DateTime.Now.AddDays(14),
                EndDate = DateTime.Now.AddDays(104),
                InstructorId = "instructor-2",
                InstructorName = "Jane Smith",
                EstimatedDuration = TimeSpan.FromHours(60),
                Modules = AddDummyModules(2)
            },
            new CourseModel
            {
                Id = 3,
                Title = "Data Science Essentials",
                Description = "An introduction to data science and analytics",
                Level = "Intermediate",
                Status = "Draft",
                MaxEnrollments = 75,
                StartDate = DateTime.Now.AddDays(21),
                EndDate = DateTime.Now.AddDays(81),
                InstructorId = "instructor-3",
                InstructorName = "Dr. Robert Johnson",
                EstimatedDuration = TimeSpan.FromHours(50),
                Modules = AddDummyModules(3)
            }
        };
    }

    private List<ModuleModel> AddDummyModules(int courseId)
    {
        // Using helper to create modules ensures Title and Description are set
        var modules = new List<ModuleModel>
        {
            CreateModule(courseId * 10 + 1, $"Module 1 - Course {courseId}", $"This is the first module for course {courseId}", courseId),
            CreateModule(courseId * 10 + 2, $"Module 2 - Course {courseId}", $"This is the second module for course {courseId}", courseId)
        };
        return modules;
    }

    private ModuleModel CreateModule(int id, string title, string description, int courseId)
    {
        return new ModuleModel
        {
            Id = id,
            Title = title,
            Description = description,
            CourseId = courseId,
            Lessons = AddDummyLessons(id)
        };
    }

    private List<LessonModel> AddDummyLessons(int moduleId)
    {
        // Using helper for lessons as well
        var lessons = new List<LessonModel>
        {
            CreateLesson(moduleId * 100 + 1, $"Lesson 1 - Module {moduleId}", $"This is the first lesson for module {moduleId}", moduleId, "Video"),
            CreateLesson(moduleId * 100 + 2, $"Lesson 2 - Module {moduleId}", $"This is the second lesson for module {moduleId}", moduleId, "Reading")
        };
        return lessons;
    }

    private LessonModel CreateLesson(int id, string title, string description, int moduleId, string type)
    {
        return new LessonModel
        {
            Id = id,
            Title = title,
            Description = description,
            ModuleId = moduleId,
            Type = type
        };
    }
}