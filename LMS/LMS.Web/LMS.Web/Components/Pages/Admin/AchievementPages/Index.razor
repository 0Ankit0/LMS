@page "/admin/achievements"
@rendermode @(new InteractiveServerRenderMode())
@attribute [OutputCache(Duration = 60)]
@using LMS.Repositories
@inject IAchievementRepository AchievementRepository
<PageTitle>Achievements - Admin</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Achievements</h1>
    <a href="/admin/achievements/create" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i>
        Add New Achievement
    </a>
</div>

<DataTableComponent TItem="AchievementModel" DataProvider="AchievementDataProvider" PageSize="10">
    <GridColumn TItem="AchievementModel" HeaderText="Name" PropertyName="Name">
        @context.Name
    </GridColumn>
    <GridColumn TItem="AchievementModel" HeaderText="Description" PropertyName="Description">
        @context.Description
    </GridColumn>
    <GridColumn TItem="AchievementModel" HeaderText="Points" PropertyName="Points">
        @context.Points
    </GridColumn>
    <GridColumn TItem="AchievementModel" HeaderText="Type" PropertyName="Type">
        @context.Type
    </GridColumn>
    <GridColumn TItem="AchievementModel" HeaderText="Active">
        @(context.IsActive ? "Yes" : "No")
    </GridColumn>
    <GridColumn TItem="AchievementModel" HeaderText="Users Earned" PropertyName="UsersEarnedCount">
        @context.UsersEarnedCount
    </GridColumn>
    <GridColumn TItem="AchievementModel" HeaderText="Actions" Sortable="false" Filterable="false">
        <div class="btn-group" role="group">
            <a href='@($"/admin/achievements/edit?id={context.Id}")' class="btn btn-primary btn-sm">
                <i class="bi bi-pencil"></i> Edit
            </a>
            <a href='@($"/admin/achievements/details?id={context.Id}")' class="btn btn-info btn-sm">
                <i class="bi bi-eye"></i> Details
            </a>
            <a href='@($"/admin/achievements/delete?id={context.Id}")' class="btn btn-danger btn-sm">
                <i class="bi bi-trash"></i> Delete
            </a>
        </div>
    </GridColumn>
</DataTableComponent>

@code {
    private GridDataProviderDelegate<AchievementModel> AchievementDataProvider { get; set; } = default!;

    protected override void OnInitialized()
    {
        AchievementDataProvider = async request =>
        {
            try
            {
                var paginationRequest = new PaginationRequest
                {
                    PageNumber = request.PageNumber,
                    PageSize = request.PageSize
                };

                var result = await AchievementRepository.GetAllAchievementsPaginatedAsync(paginationRequest);

                // Fallback data if repository returns null or empty
                if (result == null || !result.Items.Any())
                {
                    result = new PaginatedResult<AchievementModel>
                    {
                        Items = new List<AchievementModel>
        {
new AchievementModel { Id = 1, Name = "First Course Completion", Description = "Completed your first course.", Points =
100, Type = "Course", IsActive = true, CreatedAt = DateTime.Now, UsersEarnedCount = 5 },
new AchievementModel { Id = 2, Name = "Top Learner", Description = "Achieved top score in a quiz.", Points = 200, Type =
"Quiz", IsActive = true, CreatedAt = DateTime.Now, UsersEarnedCount = 2 },
new AchievementModel { Id = 3, Name = "Forum Contributor", Description = "Made 10 forum posts.", Points = 50, Type =
"Forum", IsActive = true, CreatedAt = DateTime.Now, UsersEarnedCount = 8 }
        },
                        TotalCount = 3,
                        PageNumber = request.PageNumber,
                        PageSize = request.PageSize
                    };
                }

                return await Task.FromResult(new GridDataProviderResult<AchievementModel>
                {
                    Data = result.Items,
                    TotalCount = result.TotalCount
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading achievements: {ex.Message}");
                return await Task.FromResult(new GridDataProviderResult<AchievementModel>
                {
                    Data = Enumerable.Empty<AchievementModel>(),
                    TotalCount = 0
                });
            }
        };
    }
}
