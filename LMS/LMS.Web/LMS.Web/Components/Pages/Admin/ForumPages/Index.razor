@page "/admin/forums"
@attribute [OutputCache(Duration = 60)]
@rendermode @(new InteractiveServerRenderMode())

@using LMS.Repositories
@using LMS.Data.DTOs
@using LMS.Data.Entities
@using LMS.Web.Components.Shared
@using LMS.Web.Services

@inject IForumRepository ForumRepository
@inject LMS.Web.Services.ToastService ToastService

<PageTitle>Forums - Admin</PageTitle>

<Card>
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Forums</h5>
            <a href="/admin/forums/create" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i>
                Add New Forum
            </a>
        </div>
    </div>
    <CardBody>
        <DataTableComponent TItem="ForumModel" DataProvider="ForumsDataProvider" AllowPaging="true" AllowSorting="true"
            AllowFiltering="true">
            <DataTableColumn TItem="ForumModel" HeaderText="Title" PropertyName="Title"
                SortKeySelector="item => item.Title" Filterable="true">
                @context.Title
            </DataTableColumn>
            <DataTableColumn TItem="ForumModel" HeaderText="Description" PropertyName="Description" Filterable="true">
                @context.Description
            </DataTableColumn>
            <DataTableColumn TItem="ForumModel" HeaderText="Course ID" PropertyName="CourseId"
                SortKeySelector="item => item.CourseId" HeaderTextAlignment="Alignment.End"
                TextAlignment="Alignment.End">
                @(context.CourseId?.ToString() ?? "N/A")
            </DataTableColumn>
            <DataTableColumn TItem="ForumModel" HeaderText="General" SortKeySelector="item => item.IsGeneral">
                <Badge Color="@(context.IsGeneral? BadgeColor.Info: BadgeColor.Secondary)">
                    @(context.IsGeneral ? "General" : "Course")
                </Badge>
            </DataTableColumn>
            <DataTableColumn TItem="ForumModel" HeaderText="Active" SortKeySelector="item => item.IsActive">
                <Badge Color="@(context.IsActive? BadgeColor.Success: BadgeColor.Secondary)">
                    @(context.IsActive ? "Yes" : "No")
                </Badge>
            </DataTableColumn>
            <DataTableColumn TItem="ForumModel" HeaderText="Topics" PropertyName="TopicCount"
                SortKeySelector="item => item.TopicCount" HeaderTextAlignment="Alignment.End"
                TextAlignment="Alignment.End">
                @context.TopicCount
            </DataTableColumn>
            <DataTableColumn TItem="ForumModel" HeaderText="Created" SortKeySelector="item => item.CreatedAt">
                @context.CreatedAt.ToString("yyyy-MM-dd")
            </DataTableColumn>
            <DataTableColumn TItem="ForumModel" HeaderText="Actions" Sortable="false" Filterable="false">
                <div class="btn-group" role="group">
                        <a href='@($"/admin/forums/edit?id={context.Id}")' class="btn btn-primary btn-sm">
                            <i class="bi bi-pencil"></i> Edit
                        </a>
                        <a href='@($"/admin/forums/details?id={context.Id}")' class="btn btn-info btn-sm">
                            <i class="bi bi-eye"></i> Details
                        </a>
                        <button class="btn btn-danger btn-sm" @onclick="() => ConfirmDelete(context)">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
            </DataTableColumn>
        </DataTableComponent>
    </CardBody>
</Card>

<!-- Delete Confirmation Modal -->
<ModalComponent @ref="deleteModal" Title="Confirm Delete"
    Message="@($"Are you sure you want to delete the forum '{forumToDelete?.Title}'? This action cannot be undone.")"
    ConfirmButtonText="Delete" ConfirmButtonColor="ButtonColor.Danger" OnConfirm="DeleteForum" />

@code {
    private IEnumerable<ForumModel> forums = default!;
    private ModalComponent deleteModal = default!;
    private ForumModel? forumToDelete;

    private async Task<GridDataProviderResult<ForumModel>> ForumsDataProvider(GridDataProviderRequest<ForumModel> request)
    {
        try
        {
            var result = await ForumRepository.GetForumsPaginatedAsync(new PaginationRequest
            {
                PageNumber = request.PageNumber,
                PageSize = request.PageSize
            });

            return new GridDataProviderResult<ForumModel>
            {
                Data = result.Items,
                TotalCount = result.TotalCount
            };
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Error", $"Error loading forums: {ex.Message}");
            return new GridDataProviderResult<ForumModel>
            {
                Data = Enumerable.Empty<ForumModel>(),
                TotalCount = 0
            };
        }
    }

    private async Task ConfirmDelete(ForumModel forum)
    {
        forumToDelete = forum;
        await deleteModal.ShowAsync();
    }

    private async Task DeleteForum()
    {
        if (forumToDelete != null)
        {
            try
            {
                await ForumRepository.DeleteForumAsync(forumToDelete.Id);
                ToastService.ShowSuccess("Success", $"Forum '{forumToDelete.Title}' deleted successfully.");
                await RefreshGridDataAsync();
            }
            catch (Exception ex)
            {
                ToastService.ShowError("Error", $"Error deleting forum: {ex.Message}");
            }
            finally
            {
                forumToDelete = null;
            }
        }
    }

    private async Task RefreshGridDataAsync()
    {
        await InvokeAsync(StateHasChanged);
    }
}

